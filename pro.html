<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CieloTracker Pro – Flight Weather Monitor</title>
  <style>
    :root{--bg:#f9fafb;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--brand:#0f5fff;--danger:#ef4444;--success:#10b981;--warning:#f59e0b;--trigger-bg:#ef4444;--trigger-text:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--fg);font-size:14px;min-width:320px;display:flex;flex-direction:column;height:100vh}
    .theme-dark{--bg:#0b0f14;--fg:#e5e7eb;--muted:#9ca3af;--border:#1f2937;--trigger-bg:#7f1d1d;--trigger-text:#fca5a5}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px;flex-shrink:0}
    .header-left{font-size:18px;font-weight:600;white-space:nowrap;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;padding:4px 8px;border-radius:6px;transition:background 0.2s}
    .header-left:hover{background:rgba(0,0,0,0.08)}
    .theme-dark .header-left:hover{background:rgba(255,255,255,0.08)}
    .header-center{display:flex;gap:16px;font-size:13px;color:var(--muted);flex-wrap:wrap;align-items:center}
    .stat-item{display:flex;align-items:center;gap:4px}
    .stat-label{color:var(--muted);font-size:12px}
    .stat-value{font-weight:600;font-size:13px}
    .btn{height:32px;padding:0 16px;border:none;border-radius:6px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer;font-size:13px;transition:opacity 0.2s;white-space:nowrap}
    .btn:hover{opacity:0.9}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:var(--muted)}
    .btn-success{background:var(--success)}
    .btn-warning{background:var(--warning)}
    #errorDisplay{padding:12px 16px;background:#fef2f2;color:var(--danger);border-left:4px solid var(--danger);border-bottom:1px solid var(--border);font-weight:600;font-size:13px;flex-shrink:0}
    .theme-dark #errorDisplay{background:#7f1d1d;color:#fca5a5}
    #errorDisplay.hidden{display:none!important}
    .table-wrapper{flex:1;overflow:hidden;display:flex;flex-direction:column}
    .table-container{flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;background:#fff;font-size:13px}
    .theme-dark table{background:#0d1218}
    thead{position:sticky;top:0;z-index:100}
    th{background:#f3f4f6;padding:8px 4px;text-align:left;font-weight:600;font-size:12px;border-bottom:2px solid var(--border);white-space:nowrap;user-select:none;position:relative}
    .theme-dark th{background:#1f2937}
    th .trigger-count{font-weight:700;margin-left:4px;font-size:11px}
    th .trigger-count .orange-count{color:#f59e0b}
    th .trigger-count .white-count{color:#fff;background:#dc2626;padding:1px 4px;border-radius:3px;margin-left:2px}
    td{padding:6px 4px;border-bottom:1px solid var(--border);vertical-align:middle;font-size:12px;white-space:nowrap}
    tbody tr:hover{background:#dbeafe}
    .theme-dark tbody tr:hover{background:#1e3a5f}
    tbody tr.faded{opacity:0.6}
    .taxi-burn-cell{font-style:italic;cursor:pointer}
    .taxi-burn-cell:hover{background:rgba(0,0,0,0.08)}
    .theme-dark .taxi-burn-cell:hover{background:rgba(255,255,255,0.08)}
    .editable{cursor:text;min-width:40px;padding:4px;border-radius:4px}
    .editable:hover{background:rgba(0,0,0,0.04)}
    .theme-dark .editable:hover{background:rgba(255,255,255,0.06)}
    .editable input{width:100%;min-width:50px;border:1px solid var(--brand);background:transparent;font:inherit;color:inherit;padding:3px;border-radius:3px}
    .editable input:focus{outline:2px solid var(--brand)}
    .icao-cell{font-family:monospace;font-weight:500;cursor:text;user-select:none;touch-action:manipulation;-webkit-user-select:none;-webkit-touch-callout:none}
    .icao-trigger{background:var(--trigger-bg);color:var(--trigger-text);font-weight:700;padding:2px 4px;border-radius:3px}
    .icao-bold{font-weight:700;color:#f59e0b}
    .icao-alt-critical{background:#dc2626;color:#fff;font-weight:700;padding:2px 4px;border-radius:3px}
    .flt-cell{cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation}
    .context-menu{position:fixed;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:3000;min-width:180px;animation:fadeIn 0.15s ease-out}
    .theme-dark .context-menu{background:#1f2937;border-color:#374151}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .context-menu-item{padding:10px 16px;cursor:pointer;font-size:13px;color:var(--fg);border:none;background:transparent;width:100%;text-align:left;transition:background 0.15s}
    .context-menu-item:hover{background:rgba(0,0,0,0.08)}
    .theme-dark .context-menu-item:hover{background:rgba(255,255,255,0.1)}
    .context-menu-item:first-child{border-radius:8px 8px 0 0}
    .context-menu-item:last-child{border-radius:0 0 8px 8px}
    .wx-modal-overlay,.upload-modal-overlay,.single-flight-modal-overlay,.taxi-burn-modal-overlay,.delay-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:2000;animation:fadeIn 0.2s;padding:20px}
    .upload-modal-overlay,.single-flight-modal-overlay,.taxi-burn-modal-overlay,.delay-modal-overlay{z-index:3000}
    .wx-modal,.upload-modal,.single-flight-modal,.taxi-burn-modal,.delay-modal{background:#fff;border-radius:12px;padding:20px;width:100%;max-width:700px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.3);position:relative;animation:slideUp 0.3s ease-out}
    .upload-modal,.single-flight-modal,.taxi-burn-modal,.delay-modal{max-width:500px;max-height:none;overflow-y:visible;padding:24px}
    .single-flight-modal,.taxi-burn-modal,.delay-modal{max-width:400px}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .theme-dark .wx-modal,.theme-dark .upload-modal,.theme-dark .single-flight-modal,.theme-dark .taxi-burn-modal,.theme-dark .delay-modal{background:#1f2937}
    .wx-modal-header{display:flex;justify-content:flex-end;align-items:center;margin-bottom:16px}
    .wx-modal-close{background:transparent;border:none;font-size:28px;cursor:pointer;color:var(--muted);padding:0;width:36px;height:36px;border-radius:6px}
    .wx-modal-close:hover{background:rgba(0,0,0,0.1)}
    .wx-modal-body{font-family:monospace;font-size:13px;line-height:1.8;white-space:pre-wrap;word-break:break-word;color:var(--fg);user-select:text;-webkit-user-select:text}
    .upload-modal-title,.single-flight-modal-title,.taxi-burn-modal-title,.delay-modal-title{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--fg)}
    .single-flight-modal-title,.taxi-burn-modal-title,.delay-modal-title{margin-bottom:20px}
    .upload-modal-label,.single-flight-label,.taxi-burn-label,.delay-modal-label{display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:var(--fg)}
    .single-flight-label,.taxi-burn-label,.delay-modal-label{margin-bottom:6px}
    .upload-modal-textarea,.single-flight-input,.taxi-burn-input,.delay-modal-input{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:#fff;color:var(--fg);font-family:monospace;resize:vertical}
    .upload-modal-textarea{min-height:200px}
    .delay-modal-input{resize:none}
    .theme-dark .upload-modal-textarea,.theme-dark .single-flight-input,.theme-dark .taxi-burn-input,.theme-dark .delay-modal-input{background:#111827;border-color:#374151;color:#e5e7eb}
    .upload-modal-textarea:focus,.single-flight-input:focus,.taxi-burn-input:focus,.delay-modal-input:focus{outline:2px solid var(--brand)}
    .upload-modal-actions,.single-flight-modal-actions,.taxi-burn-modal-actions,.delay-modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
    .upload-modal-actions .btn,.single-flight-modal-actions .btn,.taxi-burn-modal-actions .btn,.delay-modal-actions .btn{height:36px;padding:0 16px;font-size:13px}
    .single-flight-form-group,.taxi-burn-form-group,.delay-modal-form-group{margin-bottom:16px}
    .toast{position:fixed;top:20px;right:20px;background:#111;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:2000;animation:slideIn 0.3s ease-out;max-width:400px;display:flex;align-items:center;gap:12px}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast-success{background:var(--success)}
    .toast-error{background:var(--danger)}
    .toast-warning{background:var(--warning)}
    .toast-info{background:var(--brand)}
    .toast-btn{background:rgba(255,255,255,0.3);border:1px solid rgba(255,255,255,0.5);color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600}
    .toast-btn:hover{background:rgba(255,255,255,0.5)}
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .action-btn{padding:3px 6px;height:auto;font-size:10px;min-width:40px}
    .drag-handle{cursor:grab;padding:4px 8px;color:var(--muted);font-size:16px;user-select:none;touch-action:none}
    .drag-handle:hover{color:var(--fg)}
    .drag-handle:active{cursor:grabbing}
    tr.dragging{opacity:0.5;background:var(--brand)!important}
    tr.drag-over{border-top:3px solid var(--brand)}
    @media (max-width:768px){body{font-size:12px}.header-left{font-size:16px}table{font-size:11px}th{font-size:10px;padding:6px 3px}td{font-size:11px;padding:4px 3px}.action-btn{font-size:9px;padding:2px 4px;min-width:35px}}
    @media (max-width:480px){header{padding:8px 12px}}
    .hidden{display:none!important}
  </style>
</head>
<body class="theme-light">
  <header>
    <div class="header-left" id="headerTitle">CieloTracker <strong>Pro</strong></div>
    <div class="header-center">
      <span id="currentTime">--:-- UTC</span>
      <span id="lastUpdate">Updated: --:-- UTC</span>
      <div class="stat-item">
        <span class="stat-label">Total:</span>
        <span class="stat-value" id="statTotal">0</span>
      </div>
    </div>
  </header>
  <div id="errorDisplay" class="hidden">
    ⚠️ Weather data unavailable for 5+ minutes. Last update: <span id="errorTime">--:--</span> UTC
  </div>
  <div class="table-wrapper">
    <div class="table-container">
      <table id="flightTable">
        <thead>
          <tr>
            <th>FLT<span class="trigger-count" data-col="flight"></span></th>
            <th>ORG<span class="trigger-count" data-col="origin"></span></th>
            <th>DEST<span class="trigger-count" data-col="dest"></span></th>
            <th>T/ALT<span class="trigger-count" data-col="takeoffAlt"></span></th>
            <th>ALT1<span class="trigger-count" data-col="alt1"></span></th>
            <th>ALT2<span class="trigger-count" data-col="alt2"></span></th>
            <th>ETD<span class="trigger-count" data-col="etd"></span></th>
            <th>TAXI<span class="trigger-count" data-col="taxiOut"></span></th>
            <th>BURN<span class="trigger-count" data-col="burnoff"></span></th>
            <th>DUR<span class="trigger-count" data-col="duration"></span></th>
            <th>ETA<span class="trigger-count" data-col="eta"></span></th>
            <th>Actions<span class="trigger-count" data-col="actions"></span></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="flightTableBody">
          <tr><td colspan="13" class="loading">Left-click CieloTracker to upload flights</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
(function(){
'use strict';
const API_URL="https://us-central1-handy-coil-469714-j2.cloudfunctions.net/process-weather-data-clean";
const ERROR_THRESHOLD_MS=5*60*1000;
const HEADER_KEYWORDS=['FLT','ORG','ETD','DST','ETA','DEST','BURN','TAXI','DUR','T/ALT','ALT1','ALT2'];
const TRIGGER_TERMS=['TSRA','VCTS','FZRA','FZDZ','+SN','PSN','FZFG','GR','UP','TS','SQ'];
const FM_SPLIT=/\bFM\d{6}\b/;
const FM_FIND=/FM(\d{6})/g;
const ALWAYS_ON_CHECK_INTERVAL=30*1000;
const AUTO_REMOVE_DELAY=15*60*1000;

let flights=[];
let weatherData={};
let lastSuccessfulUpdate=null;
let autoRefreshInterval=null;
let alwaysOnCheckInterval=null;
const destImprovementCache=new Map();
let draggedIndex=null;
const autoRemoveTimeouts=new Map();

const $=(sel)=>document.querySelector(sel);
const $$=(sel)=>document.querySelectorAll(sel);
const headerTitle=$('#headerTitle');
const flightTableBody=$('#flightTableBody');
const currentTimeEl=$('#currentTime');
const lastUpdateEl=$('#lastUpdate');
const errorDisplay=$('#errorDisplay');
const errorTimeEl=$('#errorTime');
const statTotal=$('#statTotal');

function pad2(n){return String(n).padStart(2,'0')}
function getCurrentZulu(){const now=new Date();return `${pad2(now.getUTCHours())}${pad2(now.getUTCMinutes())}`}
function zuluToMinutes(hhmm){
  if(!hhmm||hhmm.length!==4)return null;
  const h=parseInt(hhmm.slice(0,2),10);
  const m=parseInt(hhmm.slice(2),10);
  return h*60+m;
}
function minutesToZulu(minutes){
  const h=Math.floor(minutes/60)%24;
  const m=minutes%60;
  return pad2(h)+pad2(m);
}
function getCurrentZuluMinutes(){
  const now=new Date();
  return now.getUTCHours()*60+now.getUTCMinutes();
}
function normalizeTime(time){
  if(!time)return '';
  const cleaned=time.replace(/[^\d]/g,'');
  if(!cleaned)return '';
  let hours=0,minutes=0;
  if(cleaned.length===1){minutes=parseInt(cleaned,10)}
  else if(cleaned.length===2){
    const num=parseInt(cleaned,10);
    if(num<=59)minutes=num;
    else{hours=Math.floor(num/100);minutes=num%100}
  }
  else if(cleaned.length===3){hours=parseInt(cleaned.slice(0,1),10);minutes=parseInt(cleaned.slice(1),10)}
  else{hours=parseInt(cleaned.slice(0,2),10);minutes=parseInt(cleaned.slice(2),10)}
  hours=hours%24;
  minutes=minutes%60;
  return pad2(hours)+pad2(minutes);
}
function formatDuration(minutes){
  if(!minutes&&minutes!==0)return '';
  const min=parseInt(minutes,10);
  if(isNaN(min))return '';
  const h=Math.floor(min/60);
  const m=min%60;
  return `${pad2(h)}${pad2(m)}`;
}
function parseDurationInput(input){
  if(!input)return '';
  const cleaned=input.replace(/[^\d]/g,'');
  if(!cleaned)return '';
  let minutes=0;
  if(cleaned.length<=2)minutes=parseInt(cleaned,10);
  else{
    const hours=parseInt(cleaned.slice(0,-2),10);
    const mins=parseInt(cleaned.slice(-2),10);
    minutes=hours*60+mins;
  }
  return String(minutes);
}
function formatZuluTime(hhmm){if(!hhmm||hhmm.length!==4)return hhmm||'';return `${hhmm.slice(0,2)}:${hhmm.slice(2)}`}
function addMinutesToZulu(hhmm,minutes){
  if(!hhmm||hhmm.length!==4)return '';
  let h=parseInt(hhmm.slice(0,2),10);
  let m=parseInt(hhmm.slice(2),10);
  m+=parseInt(minutes,10)||0;
  while(m>=60){m-=60;h++}
  while(m<0){m+=60;h--}
  while(h>=24)h-=24;
  while(h<0)h+=24;
  return pad2(h)+pad2(m);
}
function normalizeICAO(iata){
  if(!iata||iata.length<3)return iata;
  const clean=iata.trim().toUpperCase();
  if(clean.length===4)return clean;
  if(clean[0]==='Y')return 'C'+clean;
  return 'K'+clean;
}
function showToast(message,type='info',duration=3000,undoCallback=null){
  const toast=document.createElement('div');
  toast.className=`toast toast-${type}`;
  const msgSpan=document.createElement('span');
  msgSpan.textContent=message;
  toast.appendChild(msgSpan);
  if(undoCallback){
    const undoBtn=document.createElement('button');
    undoBtn.className='toast-btn';
    undoBtn.textContent='Undo';
    undoBtn.addEventListener('click',()=>{undoCallback();toast.remove()});
    toast.appendChild(undoBtn);
  }
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),duration);
}
function updateClock(){
  const now=new Date();
  currentTimeEl.textContent=`${pad2(now.getUTCHours())}:${pad2(now.getUTCMinutes())} UTC`;
  checkFlightTimes();
}
function startClock(){
  updateClock();
  const now=new Date();
  const msToNextMinute=(60-now.getUTCSeconds())*1000-now.getUTCMilliseconds();
  setTimeout(()=>{updateClock();setInterval(updateClock,60000)},msToNextMinute);
}
function applyTheme(theme){
  document.body.className=theme==='dark'?'theme-dark':'theme-light';
  localStorage.setItem('ct_pro_theme',theme);
}
function getTheme(){return localStorage.getItem('ct_pro_theme')||'light'}
function toggleTheme(){
  const current=getTheme();
  const newTheme=current==='dark'?'light':'dark';
  applyTheme(newTheme);
  closeContextMenu();
}
function parsePastedFlights(text){
  const lines=text.trim().split('\n');
  const newFlights=[];
  let startIdx=0;
  if(lines.length>0){
    const firstLine=lines[0].trim().split(/[\s\t]+/);
    if(firstLine.some(word=>HEADER_KEYWORDS.includes(word.toUpperCase())))startIdx=1;
  }
  for(let i=startIdx;i<lines.length;i++){
    if(!lines[i].trim())continue;
    const parts=lines[i].trim().split(/[\s\t]+/);
    if(parts.length<5)continue;
    const[flt,org,etd,dst,eta]=parts;
    newFlights.push({
      id:Date.now()+Math.random(),
      flight:flt,
      origin:normalizeICAO(org),
      dest:normalizeICAO(dst),
      takeoffAlt:'',
      alt1:'',
      alt2:'',
      etd:normalizeTime(etd),
      taxiOut:'',
      burnoff:'',
      duration:'',
      eta:normalizeTime(eta),
      triggers:new Set(),
      autoRemoveScheduled:false
    });
  }
  return newFlights;
}
function parseRawInput(text){
  const lines=text.trim().split('\n');
  const newFlights=[];
  for(let i=0;i<lines.length;i++){
    const line=lines[i].trim();
    if(!line)continue;
    if(/\b(DD|TIME|SQ|ALC|FLT|ORG|ETD|DST|ETA|A\/C|MAXTOW|CFP|MSGS|DISPATCH|WORKSHEET|DESK|page)\b/i.test(line))continue;
    const parts=line.split(/\s+/);
    if(parts.length<9)continue;
    const[dd,time,sq,alc,flt,org,etd,dst,eta]=parts;
    if(!flt||!org||!etd||!dst||!eta)continue;
    if(isNaN(parseInt(flt,10))||flt.length<3)continue;
    newFlights.push({
      id:Date.now()+Math.random(),
      flight:flt,
      origin:normalizeICAO(org),
      dest:normalizeICAO(dst),
      takeoffAlt:'',
      alt1:'',
      alt2:'',
      etd:normalizeTime(etd),
      taxiOut:'',
      burnoff:'',
      duration:'',
      eta:normalizeTime(eta),
      triggers:new Set(),
      autoRemoveScheduled:false
    });
  }
  return newFlights;
}
function saveFlights(){
  const flightsToSave=flights.map(f=>({...f,triggers:Array.from(f.triggers||[])}));
  localStorage.setItem('ct_pro_flights',JSON.stringify(flightsToSave));
}
function loadFlights(){
  const saved=localStorage.getItem('ct_pro_flights');
  if(saved){
    try{
      const loaded=JSON.parse(saved);
      flights=loaded.map(f=>({...f,triggers:new Set(f.triggers||[]),autoRemoveScheduled:false}));
    }catch(e){flights=[]}
  }
}
function getTaxiOutSuggestion(origin){
  const history=flights.filter(f=>f.origin===origin&&f.taxiOut).map(f=>parseInt(f.taxiOut,10)).filter(n=>!isNaN(n)).slice(-5);
  if(history.length<3)return '';
  return String(Math.round(history.reduce((a,b)=>a+b,0)/history.length));
}
function calculateDurationAndETA(flight){
  if(!flight.taxiOut||!flight.burnoff){flight.duration='';return}
  const totalMin=(parseInt(flight.taxiOut,10)||0)+(parseInt(flight.burnoff,10)||0);
  flight.duration=String(totalMin);
  if(flight.etd)flight.eta=addMinutesToZulu(flight.etd,totalMin);
}
async function fetchWeather(icaoList){
  if(!icaoList||!icaoList.length)return {};
  const params=new URLSearchParams({
    ids:icaoList.join(','),
    ceil:'2000',
    vis:'3',
    metar:'1',
    taf:'1',
    alpha:'0',
    filter:'all'
  });
  try{
    const res=await fetch(`${API_URL}?${params}`,{method:'GET',mode:'cors'});
    if(!res.ok)throw new Error(`API ${res.status}`);
    const data=await res.json();
    lastSuccessfulUpdate=new Date();
    errorDisplay.classList.add('hidden');
    const hh=pad2(lastSuccessfulUpdate.getUTCHours());
    const mm=pad2(lastSuccessfulUpdate.getUTCMinutes());
    lastUpdateEl.textContent=`Updated: ${hh}:${mm} UTC`;
    const lookup={};
    if(data.results)data.results.forEach(r=>{lookup[r.icao]=r});
    return lookup;
  }catch(err){
    if(lastSuccessfulUpdate&&(Date.now()-lastSuccessfulUpdate.getTime())>ERROR_THRESHOLD_MS){
      errorDisplay.classList.remove('hidden');
      const hh=pad2(lastSuccessfulUpdate.getUTCHours());
      const mm=pad2(lastSuccessfulUpdate.getUTCMinutes());
      errorTimeEl.textContent=`${hh}:${mm}`;
    }
    return weatherData;
  }
}
async function refreshWeather(){
  const icaos=new Set();
  flights.forEach(f=>{
    if(f.origin)icaos.add(f.origin);
    if(f.dest)icaos.add(f.dest);
    if(f.takeoffAlt)icaos.add(f.takeoffAlt);
    if(f.alt1)icaos.add(f.alt1);
    if(f.alt2)icaos.add(f.alt2);
  });
  if(icaos.size===0)return;
  weatherData=await fetchWeather(Array.from(icaos));
  checkWeatherTriggers();
  renderTable();
}
function checkMetarExpiredStatus(metarText){
  if(!metarText)return{expired:false,critical:false};
  const match=metarText.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
  if(!match)return{expired:false,critical:false};
  const day=parseInt(match[1],10);
  const hour=parseInt(match[2],10);
  const minute=parseInt(match[3],10);
  if(day<1||day>31||hour>23||minute>59)return{expired:false,critical:false};
  const now=new Date();
  const currentYear=now.getUTCFullYear();
  const currentMonth=now.getUTCMonth();
  const currentDay=now.getUTCDate();
  let metarDate=new Date(Date.UTC(currentYear,currentMonth,day,hour,minute));
  if(day>currentDay+15)metarDate=new Date(Date.UTC(currentYear,currentMonth-1,day,hour,minute));
  else if(day<currentDay-15)metarDate=new Date(Date.UTC(currentYear,currentMonth+1,day,hour,minute));
  const ageInMs=now-metarDate;
  const ageInMinutes=ageInMs/(1000*60);
  const expired=ageInMinutes>60;
  const critical=ageInMinutes>75;
  return{expired,critical};
}
function checkMissingMetarElements(metarText){
  if(!metarText)return true;
  const hasWinds=/\b(\d{3}|VRB)\d{2}(G\d{2})?KT\b|\bCALM\b/.test(metarText);
  const hasVisibility=/\b(P?\d+SM|\d+\/\d+SM)\b/.test(metarText);
  const hasSkyConditions=/\b(FEW|SCT|BKN|OVC|CLR|CLEAR|SKC|VV|CAVOK)\d*\b/.test(metarText);
  const hasTemperature=/\b(M?\d{2})\/(M?\d{2})?\b/.test(metarText);
  const hasAltimeter=/\bA\d{4}\b/.test(metarText);
  return!(hasWinds&&hasVisibility&&hasSkyConditions&&hasTemperature&&hasAltimeter);
}
function extractTafIssueTime(tafText){
  if(!tafText)return null;
  const match=tafText.match(/TAF\s+[A-Z]{4}\s+(\d{6})Z/);
  if(match)return match[1];
  return null;
}
function checkWindsInMetar(metarRaw){
  if(!metarRaw)return false;
  const windRegex=/\b(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT\b/g;
  let match;
  while((match=windRegex.exec(metarRaw))!==null){
    const speed=parseInt(match[2],10);
    const gust=match[4]?parseInt(match[4],10):0;
    if(speed>=40||gust>=40)return true;
  }
  return false;
}
function parseTafHeader(tafText){
  const m=tafText.match(/\b(\d{2})(\d{2})\/(\d{2})(\d{2})\b/);
  if(!m)return null;
  const now=new Date();
  const Y=now.getUTCFullYear();
  const M=now.getUTCMonth();
  const startDay=parseInt(m[1],10);
  const startHour=parseInt(m[2],10);
  const endDay=parseInt(m[3],10);
  const endHour=parseInt(m[4],10);
  const start=new Date(Date.UTC(Y,M,startDay,startHour,0,0));
  let end=new Date(Date.UTC(Y,M,endDay,endHour===24?0:endHour,0,0));
  if(endHour===24)end=new Date(end.getTime()+24*3600*1000);
  return{start,end,Y,M};
}
function buildTafSegments(tafRaw){
  const header=parseTafHeader(tafRaw);
  if(!header)return{segments:[],start:null,end:null};
  const{start,end,Y,M}=header;
  const parts=tafRaw.split(FM_SPLIT);
  const fmMatches=[...tafRaw.matchAll(FM_FIND)];
  const fmTimeAt=(fmIndex)=>{
    const fm=fmMatches[fmIndex];
    const d=parseInt(fm[1].slice(0,2),10);
    const h=parseInt(fm[1].slice(2,4),10);
    const m=parseInt(fm[1].slice(4,6),10);
    return new Date(Date.UTC(Y,M,d,h,m,0));
  };
  const segments=[];
  if(parts[0]){
    const firstEnd=fmMatches.length?fmTimeAt(0):end;
    segments.push({start,end:firstEnd,text:parts[0]});
  }
  for(let i=0;i<fmMatches.length;i++){
    const segStart=fmTimeAt(i);
    const segEnd=(i+1<fmMatches.length)?fmTimeAt(i+1):end;
    const text=parts[i+1]||'';
    segments.push({start:segStart,end:segEnd,text});
  }
  return{segments,start,end};
}
function etaToUtcDateWithinTaf(etaHHMM,tafStart,tafEnd){
  const h=parseInt(etaHHMM.slice(0,2),10);
  const m=parseInt(etaHHMM.slice(2),10);
  let candidate=new Date(Date.UTC(tafStart.getUTCFullYear(),tafStart.getUTCMonth(),tafStart.getUTCDate(),h,m,0));
  if(candidate<tafStart)candidate=new Date(candidate.getTime()+24*3600*1000);
  if(candidate>=tafEnd)candidate=new Date(candidate.getTime()-24*3600*1000);
  if(candidate>=tafStart&&candidate<tafEnd)return candidate;
  return null;
}
function getTafSegmentsForWindow(tafRaw,etaHHMM){
  const{segments,start,end}=buildTafSegments(tafRaw);
  if(!segments.length)return[];
  const etaDate=etaToUtcDateWithinTaf(etaHHMM,start,end);
  if(!etaDate)return[];
  const windowStart=new Date(etaDate.getTime()-60*60*1000);
  const windowEnd=new Date(etaDate.getTime()+60*60*1000);
  return segments.filter(seg=>seg.end>windowStart&&seg.start<windowEnd);
}
function getTafBaseTextAtEtaHour(tafRaw,etaHHMM){
  const{segments,start,end}=buildTafSegments(tafRaw);
  if(!segments.length)return'';
  const etaDate=etaToUtcDateWithinTaf(etaHHMM,start,end);
  if(!etaDate)return'';
  const hourMark=new Date(etaDate);
  hourMark.setUTCMinutes(0,0,0);
  const baseSeg=segments.find(seg=>seg.start<=hourMark&&hourMark<seg.end);
  return baseSeg?baseSeg.text:'';
}
function formatTAFPretty(raw){return raw.replace(/\s+FM(\d{6})/g,'\nFM$1').replace(/\s+TEMPO/g,'\nTEMPO').replace(/\s+BECMG/g,'\nBECMG').replace(/\s+PROB(30|40)/g,'\nPROB$1')}
function formatMetarForPassdown(metarRaw){return metarRaw.replace(/METAR\s+(\w{4})\s+METAR\s+\1/g,'METAR $1')}
function formatTafForPassdown(tafRaw){
  if(!tafRaw)return'';
  let cleanTaf=tafRaw.replace(/TAF\s+(\w{4})\s+TAF\s+\1/g,'TAF $1');
  cleanTaf=cleanTaf.replace(/\s+(FM\d{6})/g,'\n  $1').replace(/\s+(PROB(?:30|40))/g,'\n  $1');
  return'\n'+cleanTaf;
}
function findWorstWeather(text){
  let worstCeiling=Infinity;
  let worstVis=Infinity;
  const ceilingMatches=text.match(/\b(BKN|OVC)(\d{3})\b/g)||[];
  ceilingMatches.forEach(m=>{
    const height=parseInt(m.slice(-3),10);
    if(height<worstCeiling)worstCeiling=height;
  });
  const visMatches=text.match(/\b(\d+)SM\b/g)||[];
  visMatches.forEach(m=>{
    const vis=parseInt(m,10);
    if(vis<worstVis)worstVis=vis;
  });
  const fracVisMatches=text.match(/\b(\d+)\/(\d+)SM\b/g)||[];
  fracVisMatches.forEach(m=>{
    const parts=m.match(/(\d+)\/(\d+)/);
    if(parts){
      const vis=parseInt(parts[1],10)/parseInt(parts[2],10);
      if(vis<worstVis)worstVis=vis;
    }
  });
  return{ceiling:worstCeiling===Infinity?null:worstCeiling,visibility:worstVis===Infinity?null:worstVis};
}
function findTriggerTerms(text){
  if(!text)return[];
  const tokens=text.toUpperCase().trim().split(/\s+/);
  const out=new Set();
  for(const tokRaw of tokens){
    const tok=tokRaw.replace(/[^\+\-A-Z]/g,'');
    if(!tok)continue;
    if(tok==='+SN'){out.add('+SN');continue}
    const base=tok.replace(/^[\+\-]/,'');
    for(const term of TRIGGER_TERMS){
      if(term==='+SN')continue;
      if(base===term)out.add(term);
    }
  }
  return Array.from(out);
}
function getMetarHourHH(metarRaw){
  if(!metarRaw)return null;
  const m=metarRaw.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
  return m?m[2]:null;
}
function checkDestRequiresAlternate(wx,flight){
  if(!wx||!flight.eta)return false;
  const etaHHMM=flight.eta&&flight.eta.length===4?flight.eta:null;
  if(!etaHHMM)return false;
  const durationMin=parseInt(flight.duration,10);
  
  const tafSegs=getTafSegmentsForWindow(wx.taf?.raw||'',etaHHMM);
  const windowText=tafSegs.map(s=>s.text).join(' ');
  if(windowText){
    const worst=findWorstWeather(windowText);
    if(worst.ceiling!==null&&(worst.ceiling*100)<2000)return true;
    if(worst.visibility!==null&&worst.visibility<3)return true;
  }
  
  if(wx.taf&&wx.taf.raw){
    const tafTextAtHour=getTafBaseTextAtEtaHour(wx.taf.raw,etaHHMM);
    const tafTerms=findTriggerTerms(tafTextAtHour);
    if(tafTerms.length>0)return true;
  }
  
  if(wx.metar&&wx.metar.raw){
    const metarHH=getMetarHourHH(wx.metar.raw);
    const etaHH=etaHHMM.slice(0,2);
    if(metarHH===etaHH){
      if(checkWindsInMetar(wx.metar.raw))return true;
      if(durationMin<60){
        const worst=findWorstWeather(wx.metar.raw);
        if(worst.ceiling!==null&&(worst.ceiling*100)<2000)return true;
        if(worst.visibility!==null&&worst.visibility<3)return true;
        const metarTerms=findTriggerTerms(wx.metar.raw);
        if(metarTerms.length>0)return true;
      }
    }
  }
  
  return false;
}
function checkDestBelowApproachMins(wx,etaHHMM){
  if(!wx||!wx.metar||!wx.metar.raw||!etaHHMM)return false;
  const metarHH=getMetarHourHH(wx.metar.raw);
  const etaHH=etaHHMM.slice(0,2);
  if(metarHH!==etaHH)return false;
  const worst=findWorstWeather(wx.metar.raw);
  if(worst.ceiling!==null&&(worst.ceiling*100)<=200)return true;
  if(worst.visibility!==null&&worst.visibility<=0.5)return true;
  return false;
}
function checkAlternateAtEta(wx,etaHHMM,flight){
  if(!wx||!etaHHMM)return false;
  const etaHH=etaHHMM.slice(0,2);
  const durationMin=flight?parseInt(flight.duration,10):999;
  
  if(wx.taf&&wx.taf.raw){
    const{segments,start,end}=buildTafSegments(wx.taf.raw);
    if(segments.length>0){
      const etaDate=etaToUtcDateWithinTaf(etaHHMM,start,end);
      if(etaDate){
        const hourMark=new Date(etaDate);
        hourMark.setUTCMinutes(0,0,0);
        const exactSeg=segments.find(seg=>seg.start<=hourMark&&hourMark<seg.end);
        if(exactSeg&&exactSeg.text){
          const worst=findWorstWeather(exactSeg.text);
          if(worst.ceiling!==null&&(worst.ceiling*100)<600)return true;
          if(worst.visibility!==null&&worst.visibility<1.5)return true;
        }
      }
    }
  }
  
  if(durationMin<60&&wx.metar&&wx.metar.raw){
    const metarHH=getMetarHourHH(wx.metar.raw);
    if(metarHH===etaHH){
      const worst=findWorstWeather(wx.metar.raw);
      if(worst.ceiling!==null&&(worst.ceiling*100)<600)return true;
      if(worst.visibility!==null&&worst.visibility<1.5)return true;
    }
  }
  
  return false;
}
function checkTakeoffAltRequired(originWx,flight){
  if(!originWx||!originWx.metar||!originWx.metar.raw||!flight.etd)return false;
  const worst=findWorstWeather(originWx.metar.raw);
  if(worst.visibility!==null&&worst.visibility<1)return true;
  return false;
}
function checkWeatherTriggers(){
  flights.forEach(flight=>{
    flight.triggers.clear();
    flight.hasWindTrigger=false;
    flight.hasAdverseWeather=false;
    flight.destRequiresAlt=false;
    flight.destBelowApproachMins=false;
    
    const originWx=weatherData[flight.origin];
    const destWx=weatherData[flight.dest];
    const taltWx=flight.takeoffAlt?weatherData[flight.takeoffAlt]:null;
    const alt1Wx=flight.alt1?weatherData[flight.alt1]:null;
    const alt2Wx=flight.alt2?weatherData[flight.alt2]:null;
    
    const etaHHMM=flight.eta&&flight.eta.length===4?flight.eta:null;
    const etdHHMM=flight.etd&&flight.etd.length===4?flight.etd:null;
    const currentMinutes=getCurrentZuluMinutes();
    const etdMinutes=etdHHMM?zuluToMinutes(etdHHMM):null;
    const minutesPastEtd=etdMinutes!==null?currentMinutes-etdMinutes:null;
    
    flight.destRequiresAlt=checkDestRequiresAlternate(destWx,flight);
    flight.destBelowApproachMins=destWx&&etaHHMM?checkDestBelowApproachMins(destWx,etaHHMM):false;
    
    if(flight.destRequiresAlt){
      if(!flight.alt1&&!flight.alt2)flight.triggers.add(`${flight.dest}:dest-noalt`);
      else flight.triggers.add(`${flight.dest}:dest`);
    }
    
    if(flight.destBelowApproachMins)flight.triggers.add(`${flight.dest}:dest-approach-mins`);
    
    if(destWx&&etaHHMM){
      const metarHH=getMetarHourHH(destWx.metar?.raw||'');
      const etaHH=etaHHMM.slice(0,2);
      if(metarHH===etaHH){
        if(checkWindsInMetar(destWx.metar.raw))flight.hasWindTrigger=true;
        if(destWx.taf&&destWx.taf.raw){
          const tafTextAtHour=getTafBaseTextAtEtaHour(destWx.taf.raw,etaHHMM);
          const tafTerms=findTriggerTerms(tafTextAtHour);
          if(tafTerms.length>0)flight.hasAdverseWeather=true;
        }
        if(!flight.hasAdverseWeather&&destWx.metar&&destWx.metar.raw){
          const metarTerms=findTriggerTerms(destWx.metar.raw);
          if(metarTerms.length>0)flight.hasAdverseWeather=true;
        }
      }
    }
    
    const prevDestTrigger=flight.prevDestTrigger!==undefined?flight.prevDestTrigger:flight.destRequiresAlt;
    trackDestinationImprovement(flight,destWx,prevDestTrigger,flight.destRequiresAlt);
    flight.prevDestTrigger=flight.destRequiresAlt;
    
    if(checkTakeoffAltRequired(originWx,flight)){
      if(minutesPastEtd===null||minutesPastEtd<0){
        if(!flight.takeoffAlt)flight.triggers.add(`${flight.origin}:origin-red`);
        else flight.triggers.add(`${flight.origin}:origin-bold`);
      }else if(minutesPastEtd>=15){
        flight.triggers.add(`${flight.origin}:origin-bold`);
      }else{
        if(!flight.takeoffAlt)flight.triggers.add(`${flight.origin}:origin-red`);
        else flight.triggers.add(`${flight.origin}:origin-bold`);
      }
    }
    
    if(alt1Wx&&etaHHMM&&checkAlternateAtEta(alt1Wx,etaHHMM,flight)){
      flight.triggers.add(`${flight.alt1}:alt-critical`);
    }
    if(alt2Wx&&etaHHMM&&checkAlternateAtEta(alt2Wx,etaHHMM,flight)){
      flight.triggers.add(`${flight.alt2}:alt-critical`);
    }
    if(taltWx&&etaHHMM&&checkAlternateAtEta(taltWx,etaHHMM,flight)){
      flight.triggers.add(`${flight.takeoffAlt}:talt-critical`);
    }
  });
}
function trackDestinationImprovement(flight,destWx,prevTrigger,currentTrigger){
  if(!destWx||!destWx.taf||!destWx.taf.raw)return;
  const currentIssueTime=extractTafIssueTime(destWx.taf.raw);
  if(!currentIssueTime)return;
  const cacheKey=`${flight.id}_${flight.dest}`;
  const cached=destImprovementCache.get(cacheKey);
  if(!cached){
    destImprovementCache.set(cacheKey,{issueTime:currentIssueTime,showIndicator:false,wasTriggered:currentTrigger});
    return;
  }
  if(cached.issueTime===currentIssueTime){
    if(cached.showIndicator&&!currentTrigger)flight.triggers.add(`${flight.dest}:improved`);
    return;
  }
  const improved=prevTrigger&&!currentTrigger;
  destImprovementCache.set(cacheKey,{issueTime:currentIssueTime,showIndicator:improved,wasTriggered:currentTrigger});
  if(improved)flight.triggers.add(`${flight.dest}:improved`);
}
function getMetarIndicators(icao){
  if(!icao)return'';
  const wx=weatherData[icao];
  if(!wx)return'';
  let indicators='';
  const metarText=wx.metar?.raw||'';
  const expiredStatus=checkMetarExpiredStatus(metarText);
  if(expiredStatus.critical)indicators+=' ⏰';
  else if(expiredStatus.expired)indicators+=' ⏲';
  if(checkMissingMetarElements(metarText))indicators+=' ?';
  return indicators;
}
function escapeHtml(text){
  const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return text.replace(/[&<>"']/g,m=>map[m]);
}
function showWeatherModal(icao){
  const wx=weatherData[icao];
  const overlay=document.createElement('div');
  overlay.className='wx-modal-overlay';
  const modal=document.createElement('div');
  modal.className='wx-modal';
  let content='';
  if(wx&&wx.metar&&wx.metar.raw)content+=escapeHtml(wx.metar.raw);
  if(wx&&wx.taf&&wx.taf.raw){
    if(content)content+='\n\n';
    content+=escapeHtml(formatTAFPretty(wx.taf.raw));
  }
  if(!content)content='No weather data available';
  modal.innerHTML=`<div class="wx-modal-header"><button class="wx-modal-close" id="closeModal">×</button></div><div class="wx-modal-body">${content}</div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const closeModal=()=>overlay.remove();
  modal.querySelector('#closeModal').addEventListener('click',closeModal);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
}
function showUploadModal(){
  const overlay=document.createElement('div');
  overlay.className='upload-modal-overlay';
  const modal=document.createElement('div');
  modal.className='upload-modal';
  modal.innerHTML=`<div class="upload-modal-title">Upload Flight List</div><label class="upload-modal-label">Paste Flight List (FLT ORG ETD DST ETA) – one flight per line:</label><textarea id="uploadTextarea" class="upload-modal-textarea" placeholder="5002 ORD 2218 LEX 2345
5004 DEN 345 ATL 715
5006 LAX 1915 JFK 345"></textarea><div class="upload-modal-actions"><button class="btn btn-secondary" id="uploadCancelBtn">Cancel</button><button class="btn btn-success" id="uploadSubmitBtn">Submit</button></div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const textarea=modal.querySelector('#uploadTextarea');
  const cancelBtn=modal.querySelector('#uploadCancelBtn');
  const submitBtn=modal.querySelector('#uploadSubmitBtn');
  const closeModal=()=>overlay.remove();
  const submit=()=>{
    const text=textarea.value.trim();
    if(!text){showToast('Please enter flight data','warning');return}
    const parsed=parsePastedFlights(text);
    if(parsed.length>0){
      flights=parsed;
      renderTable();
      refreshWeather();
      closeModal();
      showToast(`Loaded ${parsed.length} flights`,'success');
    }else{showToast('No valid flights found','warning')}
  };
  textarea.addEventListener('keydown',e=>{if(e.key==='Enter'&&e.ctrlKey){e.preventDefault();submit()}});
  cancelBtn.addEventListener('click',closeModal);
  submitBtn.addEventListener('click',submit);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
  textarea.focus();
}
function showSingleFlightModal(){
  const overlay=document.createElement('div');
  overlay.className='single-flight-modal-overlay';
  const modal=document.createElement('div');
  modal.className='single-flight-modal';
  modal.innerHTML=`<div class="single-flight-modal-title">Add Single Flight</div><div class="single-flight-form-group"><label class="single-flight-label">Flight Number</label><input type="text" id="singleFlightInput" class="single-flight-input" placeholder="e.g., 5002"></div><div class="single-flight-form-group"><label class="single-flight-label">Origin</label><input type="text" id="singleOriginInput" class="single-flight-input" placeholder="e.g., ORD"></div><div class="single-flight-form-group"><label class="single-flight-label">Destination</label><input type="text" id="singleDestInput" class="single-flight-input" placeholder="e.g., LEX"></div><div class="single-flight-form-group"><label class="single-flight-label">ETD (HHMM)</label><input type="text" id="singleETDInput" class="single-flight-input" placeholder="e.g., 2218"></div><div class="single-flight-form-group"><label class="single-flight-label">ETA (HHMM)</label><input type="text" id="singleETAInput" class="single-flight-input" placeholder="e.g., 2345"></div><div class="single-flight-modal-actions"><button class="btn btn-secondary" id="singleCancelBtn">Cancel</button><button class="btn btn-success" id="singleSubmitBtn">Add Flight</button></div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const fltInput=modal.querySelector('#singleFlightInput');
  const orgInput=modal.querySelector('#singleOriginInput');
  const destInput=modal.querySelector('#singleDestInput');
  const etdInput=modal.querySelector('#singleETDInput');
  const etaInput=modal.querySelector('#singleETAInput');
  const cancelBtn=modal.querySelector('#singleCancelBtn');
  const submitBtn=modal.querySelector('#singleSubmitBtn');
  const closeModal=()=>overlay.remove();
  const submit=()=>{
    const flt=fltInput.value.trim();
    const org=orgInput.value.trim();
    const dest=destInput.value.trim();
    const etd=etdInput.value.trim();
    const eta=etaInput.value.trim();
    if(!flt||!org||!dest||!etd||!eta){showToast('Please fill in all fields','warning');return}
    const newFlight={id:Date.now()+Math.random(),flight:flt,origin:normalizeICAO(org),dest:normalizeICAO(dest),takeoffAlt:'',alt1:'',alt2:'',etd:normalizeTime(etd),taxiOut:'',burnoff:'',duration:'',eta:normalizeTime(eta),triggers:new Set(),autoRemoveScheduled:false};
    flights.unshift(newFlight);
    renderTable();
    refreshWeather();
    closeModal();
    showToast(`Flight ${flt} added`,'success');
  };
  fltInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();orgInput.focus()}});
  orgInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();destInput.focus()}});
  destInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();etdInput.focus()}});
  etdInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();etaInput.focus()}});
  etaInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();submit()}});
  cancelBtn.addEventListener('click',closeModal);
  submitBtn.addEventListener('click',submit);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
  fltInput.focus();
}
function showRawInputModal(){
  const overlay=document.createElement('div');
  overlay.className='upload-modal-overlay';
  const modal=document.createElement('div');
  modal.className='upload-modal';
  modal.innerHTML=`<div class="upload-modal-title">Raw Dispatch Input</div><label class="upload-modal-label">Paste dispatch worksheet data:</label><textarea id="rawInputTextarea" class="upload-modal-textarea" placeholder="42 1000 10 SKW 3861  MOT    1100  MSP    1235  013          001
42 1007 10 SKW 4680  BTR    1107  IAH    1233  131S         001"></textarea><div class="upload-modal-actions"><button class="btn btn-secondary" id="rawCancelBtn">Cancel</button><button class="btn btn-success" id="rawSubmitBtn">Submit</button></div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const textarea=modal.querySelector('#rawInputTextarea');
  const cancelBtn=modal.querySelector('#rawCancelBtn');
  const submitBtn=modal.querySelector('#rawSubmitBtn');
  const closeModal=()=>overlay.remove();
  const submit=()=>{
    const text=textarea.value.trim();
    if(!text){showToast('Please enter flight data','warning');return}
    const parsed=parseRawInput(text);
    if(parsed.length>0){
      flights=parsed;
      renderTable();
      refreshWeather();
      closeModal();
      showToast(`Loaded ${parsed.length} flights`,'success');
    }else{showToast('No valid flights found','warning')}
  };
  textarea.addEventListener('keydown',e=>{if(e.key==='Enter'&&e.ctrlKey){e.preventDefault();submit()}});
  cancelBtn.addEventListener('click',closeModal);
  submitBtn.addEventListener('click',submit);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
  textarea.focus();
}
function showTaxiBurnModal(idx){
  const flight=flights[idx];
  const overlay=document.createElement('div');
  overlay.className='taxi-burn-modal-overlay';
  const modal=document.createElement('div');
  modal.className='taxi-burn-modal';
  const title=`${flight.flight} (${flight.origin} → ${flight.dest})`;
  modal.innerHTML=`<div class="taxi-burn-modal-title">${title}</div><div class="taxi-burn-form-group"><label class="taxi-burn-label">Taxi Out (minutes)</label><input type="text" id="taxiOutInput" class="taxi-burn-input" placeholder="e.g., 15 or 0015" value="${formatDuration(flight.taxiOut)}"></div><div class="taxi-burn-form-group"><label class="taxi-burn-label">Burn (minutes)</label><input type="text" id="burnInput" class="taxi-burn-input" placeholder="e.g., 240 or 0400" value="${formatDuration(flight.burnoff)}"></div><div class="taxi-burn-modal-actions"><button class="btn btn-secondary" id="cancelBtn">Cancel</button><button class="btn btn-success" id="saveBtn">Save</button></div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const taxiOutInput=modal.querySelector('#taxiOutInput');
  const burnInput=modal.querySelector('#burnInput');
  const cancelBtn=modal.querySelector('#cancelBtn');
  const saveBtn=modal.querySelector('#saveBtn');
  const closeModal=()=>overlay.remove();
  const save=()=>{
    let taxiValue=taxiOutInput.value.trim();
    let burnValue=burnInput.value.trim();
    if(taxiValue)taxiValue=parseDurationInput(taxiValue);
    if(burnValue)burnValue=parseDurationInput(burnValue);
    flights[idx].taxiOut=taxiValue;
    flights[idx].burnoff=burnValue;
    if(flights[idx].taxiOut&&!flights[idx].burnoff&&getTaxiOutSuggestion(flights[idx].origin)){
      flights[idx].taxiOut=getTaxiOutSuggestion(flights[idx].origin);
    }
    calculateDurationAndETA(flights[idx]);
    renderTable();
    refreshWeather();
    closeModal();
    showToast('Taxi and Burn times saved','success');
  };
  taxiOutInput.addEventListener('keydown',e=>{if(e.key==='Tab'){e.preventDefault();burnInput.focus();burnInput.select()}});
  burnInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();save()}});
  cancelBtn.addEventListener('click',closeModal);
  saveBtn.addEventListener('click',save);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
  taxiOutInput.focus();
  taxiOutInput.select();
}
function showDelayModal(idx){
  const flight=flights[idx];
  const overlay=document.createElement('div');
  overlay.className='delay-modal-overlay';
  const modal=document.createElement('div');
  modal.className='delay-modal';
  const title=`Delay ${flight.flight}`;
  modal.innerHTML=`<div class="delay-modal-title">${title}</div><div class="delay-modal-form-group"><label class="delay-modal-label">Remaining flight time (minutes)</label><input type="text" id="delayInput" class="delay-modal-input" placeholder="e.g., 240"></div><div class="delay-modal-actions"><button class="btn btn-secondary" id="delayCancelBtn">Cancel</button><button class="btn btn-success" id="delaySubmitBtn">Update ETA</button></div>`;
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  const delayInput=modal.querySelector('#delayInput');
  const cancelBtn=modal.querySelector('#delayCancelBtn');
  const submitBtn=modal.querySelector('#delaySubmitBtn');
  const closeModal=()=>overlay.remove();
  const submit=()=>{
    const delayValue=delayInput.value.trim();
    if(!delayValue){showToast('Please enter remaining flight time','warning');return}
    const minutes=parseInt(parseDurationInput(delayValue),10);
    if(isNaN(minutes)||minutes<=0){showToast('Please enter a valid number of minutes','warning');return}
    const currentMinutes=getCurrentZuluMinutes();
    const newEtaMinutes=(currentMinutes+minutes)%(24*60);
    flights[idx].eta=minutesToZulu(newEtaMinutes);
    flights[idx].isPastEta=false;
    flights[idx].minutesPastEta=0;
    if(flights[idx].autoRemoveScheduled){
      const timeoutId=autoRemoveTimeouts.get(flights[idx].id);
      if(timeoutId)clearTimeout(timeoutId);
      autoRemoveTimeouts.delete(flights[idx].id);
      flights[idx].autoRemoveScheduled=false;
    }
    renderTable();
    closeModal();
    showToast(`ETA updated to ${formatZuluTime(flights[idx].eta)}`,'success');
  };
  delayInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();submit()}});
  cancelBtn.addEventListener('click',closeModal);
  submitBtn.addEventListener('click',submit);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()},{once:true});
  delayInput.focus();
  delayInput.select();
}
function checkFlightTimes(){
  flights.forEach(flight=>{
    if(!flight.eta)return;
    const etaMinutes=zuluToMinutes(flight.eta);
    if(etaMinutes===null)return;
    const currentMinutes=getCurrentZuluMinutes();
    let diff=etaMinutes-currentMinutes;
    if(diff<-12*60)diff+=24*60;
    else if(diff>12*60)diff-=24*60;
    
    if(diff<0){
      flight.isPastEta=true;
      flight.minutesPastEta=Math.abs(diff);
      if(flight.minutesPastEta>=30&&!flight.autoRemoveScheduled){
        flight.autoRemoveScheduled=true;
        const delayBeforeRemove=Math.max(0,AUTO_REMOVE_DELAY-(flight.minutesPastEta-30)*60*1000);
        const timeoutId=setTimeout(()=>{
          const idx=flights.findIndex(f=>f.id===flight.id);
          if(idx>=0){
            flights.splice(idx,1);
            autoRemoveTimeouts.delete(flight.id);
            renderTable();
            showToast(`Flight ${flight.flight} auto-removed`,'info');
          }
        },delayBeforeRemove);
        autoRemoveTimeouts.set(flight.id,timeoutId);
      }
    }else{
      flight.isPastEta=false;
      flight.minutesPastEta=0;
      if(flight.autoRemoveScheduled){
        const timeoutId=autoRemoveTimeouts.get(flight.id);
        if(timeoutId)clearTimeout(timeoutId);
        autoRemoveTimeouts.delete(flight.id);
        flight.autoRemoveScheduled=false;
      }
    }
  });
  renderTable();
}
function closeContextMenu(){
  const existing=$('.context-menu');
  if(existing)existing.remove();
}
function showContextMenu(e){
  e.preventDefault();
  e.stopPropagation();
  closeContextMenu();
  const menu=document.createElement('div');
  menu.className='context-menu';
  const uploadItem=document.createElement('button');
  uploadItem.className='context-menu-item';
  uploadItem.textContent='Upload Flights';
  uploadItem.addEventListener('click',()=>{closeContextMenu();showUploadModal()});
  const singleFlightItem=document.createElement('button');
  singleFlightItem.className='context-menu-item';
  singleFlightItem.textContent='Add Single Flight';
  singleFlightItem.addEventListener('click',()=>{closeContextMenu();showSingleFlightModal()});
  const rawInputItem=document.createElement('button');
  rawInputItem.className='context-menu-item';
  rawInputItem.textContent='Raw Input';
  rawInputItem.addEventListener('click',()=>{closeContextMenu();showRawInputModal()});
  const summaryItem=document.createElement('button');
  summaryItem.className='context-menu-item';
  summaryItem.textContent='Summary';
  summaryItem.addEventListener('click',()=>{
    closeContextMenu();
    const flightsToPass=flights.map(f=>({...f,triggers:Array.from(f.triggers||[])}));
    localStorage.setItem('ct_pro_flights_for_summary',JSON.stringify(flightsToPass));
    window.open('summary.html','CieloTracker_Summary');
  });
  const passdownItem=document.createElement('button');
  passdownItem.className='context-menu-item';
  passdownItem.textContent='Passdown';
  passdownItem.addEventListener('click',()=>{
    closeContextMenu();
    const flightsToPass=flights.map(f=>({
      flight:String(f.flight||''),
      origin:(f.origin||'').toUpperCase(),
      dest:(f.dest||'').toUpperCase(),
      takeoffAlt:(f.takeoffAlt||'').toUpperCase(),
      alt1:(f.alt1||'').toUpperCase(),
      alt2:(f.alt2||'').toUpperCase(),
      etd:f.etd||'',
      eta:f.eta||''
    }));
    const weatherToPass={};
    flightsToPass.forEach(f=>{
      [f.dest,f.takeoffAlt,f.alt1,f.alt2].forEach(icao=>{
        if(!icao||weatherToPass[icao])return;
        const wx=weatherData[icao];
        if(!wx)return;
        weatherToPass[icao]={
          metar:wx.metar&&typeof wx.metar.raw==='string'?{raw:formatMetarForPassdown(wx.metar.raw)}:null,
          taf:wx.taf&&typeof wx.taf.raw==='string'?{raw:formatTafForPassdown(wx.taf.raw)}:null
        };
      });
    });
    localStorage.setItem('ct_pro_flights_for_passdown',JSON.stringify(flightsToPass));
    localStorage.setItem('ct_pro_weather_for_passdown',JSON.stringify(weatherToPass));
    window.open('passdown.html','CieloTracker_Passdown');
  });
  const themeItem=document.createElement('button');
  themeItem.className='context-menu-item';
  const currentTheme=getTheme();
  themeItem.textContent=currentTheme==='dark'?'Light Theme':'Dark Theme';
  themeItem.addEventListener('click',()=>{toggleTheme()});
  menu.appendChild(uploadItem);
  menu.appendChild(singleFlightItem);
  menu.appendChild(rawInputItem);
  menu.appendChild(summaryItem);
  menu.appendChild(passdownItem);
  menu.appendChild(themeItem);
  document.body.appendChild(menu);
  const x=e.clientX||0;
  const y=e.clientY||0;
  menu.style.position='fixed';
  menu.style.left=x+'px';
  menu.style.top=y+'px';
  setTimeout(()=>{document.addEventListener('click',closeContextMenu,{once:true})},0);
}
headerTitle.addEventListener('click',e=>{e.preventDefault();e.stopPropagation();showContextMenu(e)});
headerTitle.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();showContextMenu(e)});
function updateTriggerCounts(){
  const columnTriggerCounts={flight:0,origin:0,dest:0,takeoffAlt:0,alt1:0,alt2:0,etd:0,taxiOut:0,burnoff:0,duration:0,eta:0,actions:0};
  const orangeCounts={flight:0,origin:0,dest:0,takeoffAlt:0,alt1:0,alt2:0,etd:0,taxiOut:0,burnoff:0,duration:0,eta:0,actions:0};
  const whiteCounts={flight:0,origin:0,dest:0,takeoffAlt:0,alt1:0,alt2:0,etd:0,taxiOut:0,burnoff:0,duration:0,eta:0,actions:0};
  
  flights.forEach(flight=>{
    if(flight.triggers.size>0){
      if(flight.triggers.has(`${flight.origin}:origin-red`)){whiteCounts.origin++;columnTriggerCounts.origin++}
      else if(flight.triggers.has(`${flight.origin}:origin-bold`)){orangeCounts.origin++;columnTriggerCounts.origin++}
      
      if(flight.triggers.has(`${flight.dest}:dest-noalt`)){whiteCounts.dest++;columnTriggerCounts.dest++}
      else if(flight.triggers.has(`${flight.dest}:dest`)||flight.triggers.has(`${flight.dest}:dest-approach-mins`)){orangeCounts.dest++;columnTriggerCounts.dest++}
      
      if(flight.triggers.has(`${flight.takeoffAlt}:talt-critical`)){whiteCounts.takeoffAlt++;columnTriggerCounts.takeoffAlt++}
      
      if(flight.triggers.has(`${flight.alt1}:alt-critical`)){whiteCounts.alt1++;columnTriggerCounts.alt1++}
      if(flight.triggers.has(`${flight.alt2}:alt-critical`)){whiteCounts.alt2++;columnTriggerCounts.alt2++}
    }
  });
  
  $$('th .trigger-count').forEach(span=>{
    const col=span.dataset.col;
    const orange=orangeCounts[col]||0;
    const white=whiteCounts[col]||0;
    if(orange>0||white>0){
      let html='';
      if(orange>0)html+=`<span class="orange-count">${orange}</span>`;
      if(white>0)html+=`<span class="white-count">${white}</span>`;
      span.innerHTML=html;
      span.style.display='inline';
    }else{
      span.innerHTML='';
      span.style.display='none';
    }
  });
}
function renderTable(){
  if(!flights.length){
    flightTableBody.innerHTML='<tr><td colspan="13" class="loading">Left-click CieloTracker to upload flights</td></tr>';
    updateStats();
    updateTriggerCounts();
    return;
  }
  flightTableBody.innerHTML='';
  flights.forEach((flight,actualIdx)=>{
    const row=document.createElement('tr');
    row.draggable=true;
    row.dataset.index=actualIdx;
    if(flight.isPastEta)row.classList.add('faded');
    
    const actionsHtml=flight.isPastEta?`<button class="btn btn-warning action-btn" onclick="window.flightActions.delay(${actualIdx})">Delay</button>`:'';
    
    row.innerHTML=`<td class="flt-cell" data-idx="${actualIdx}">${flight.flight}</td><td class="icao-cell editable" data-idx="${actualIdx}" data-field="origin" data-icao="${flight.origin}">${renderICAO(flight,'origin')}</td><td class="icao-cell editable" data-idx="${actualIdx}" data-field="dest" data-icao="${flight.dest}">${renderICAO(flight,'dest')}</td><td class="icao-cell editable" data-idx="${actualIdx}" data-field="takeoffAlt" data-icao="${flight.takeoffAlt||''}">${renderICAO(flight,'takeoffAlt')}</td><td class="icao-cell editable" data-idx="${actualIdx}" data-field="alt1" data-icao="${flight.alt1||''}">${renderICAO(flight,'alt1')}</td><td class="icao-cell editable" data-idx="${actualIdx}" data-field="alt2" data-icao="${flight.alt2||''}">${renderICAO(flight,'alt2')}</td><td class="editable" data-idx="${actualIdx}" data-field="etd">${formatZuluTime(flight.etd)}</td><td class="taxi-burn-cell" data-idx="${actualIdx}" data-field="taxiOut">${formatDuration(flight.taxiOut)}</td><td class="taxi-burn-cell" data-idx="${actualIdx}" data-field="burnoff">${formatDuration(flight.burnoff)}</td><td>${formatDuration(flight.duration)}</td><td>${formatZuluTime(flight.eta)}</td><td style="white-space:nowrap;">${actionsHtml}</td><td><span class="drag-handle">⋮⋮</span></td>`;
    row.addEventListener('dragstart',handleDragStart);
    row.addEventListener('dragend',handleDragEnd);
    row.addEventListener('dragover',handleDragOver);
    row.addEventListener('drop',handleDrop);
    row.addEventListener('dragenter',handleDragEnter);
    row.addEventListener('dragleave',handleDragLeave);
    flightTableBody.appendChild(row);
  });
  attachEditListeners();
  updateStats();
  updateTriggerCounts();
  saveFlights();
}
function handleDragStart(e){
  draggedIndex=parseInt(this.dataset.index,10);
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed='move';
  e.dataTransfer.setData('text/html',this.innerHTML);
}
function handleDragEnd(e){
  this.classList.remove('dragging');
  $$('tr').forEach(row=>row.classList.remove('drag-over'));
}
function handleDragOver(e){
  if(e.preventDefault)e.preventDefault();
  e.dataTransfer.dropEffect='move';
  return false;
}
function handleDragEnter(e){
  if(this.draggable)this.classList.add('drag-over');
}
function handleDragLeave(e){
  this.classList.remove('drag-over');
}
function handleDrop(e){
  if(e.stopPropagation)e.stopPropagation();
  const dropIndex=parseInt(this.dataset.index,10);
  if(draggedIndex!==dropIndex){
    const draggedFlight=flights[draggedIndex];
    flights.splice(draggedIndex,1);
    const newIndex=draggedIndex<dropIndex?dropIndex-1:dropIndex;
    flights.splice(newIndex,0,draggedFlight);
    renderTable();
    showToast('Flight order updated','success',2000);
  }
  return false;
}
function renderICAO(flight,field){
  const icao=flight[field];
  if(!icao)return['takeoffAlt','alt1','alt2'].includes(field)?'—':'';
  let triggerType=null;
  
  if(field==='origin'){
    if(flight.triggers.has(`${icao}:origin-red`))triggerType='red';
    else if(flight.triggers.has(`${icao}:origin-bold`))triggerType='bold';
  }else if(field==='dest'){
    if(flight.triggers.has(`${icao}:improved`)){
      triggerType=null;
    }else{
      if(flight.triggers.has(`${icao}:dest-noalt`))triggerType='red';
      else if(flight.triggers.has(`${icao}:dest`)||flight.triggers.has(`${icao}:dest-approach-mins`))triggerType='bold';
    }
  }else if(field==='takeoffAlt'){
    if(flight.triggers.has(`${icao}:talt-critical`))triggerType='red';
  }else if(field==='alt1'||field==='alt2'){
    if(flight.triggers.has(`${icao}:alt-critical`))triggerType='red';
  }
  
  let html=icao;
  if(triggerType==='red')html=`<span class="icao-trigger">${icao}</span>`;
  else if(triggerType==='bold')html=`<span class="icao-bold">${icao}</span>`;
  
  html+=getMetarIndicators(icao);
  
  if(field==='dest'){
    if(flight.triggers.has(`${icao}:improved`)&&!flight.destRequiresAlt)html+=' +';
    if(flight.hasAdverseWeather)html+=' ⚡';
    if(flight.hasWindTrigger)html+=' 🌬️';
    if(flight.destBelowApproachMins)html+=' ⚠';
  }
  
  return html;
}
function attachEditListeners(){
  flightTableBody.querySelectorAll('[data-field="taxiOut"]').forEach(cell=>{
    cell.addEventListener('click',function(){const idx=parseInt(this.dataset.idx,10);showTaxiBurnModal(idx)});
  });
  flightTableBody.querySelectorAll('.editable').forEach(cell=>{
    let touchStartTime=0,touchMoved=false;
    cell.addEventListener('click',function(e){if(e.button!==0||this.querySelector('input'))return;startEdit(this)});
    cell.addEventListener('touchstart',function(){touchStartTime=Date.now();touchMoved=false},{passive:true});
    cell.addEventListener('touchmove',function(){touchMoved=true},{passive:true});
    cell.addEventListener('touchend',function(e){
      const touchDuration=Date.now()-touchStartTime;
      const icao=this.dataset.icao;
      if(!touchMoved&&touchDuration>500&&icao&&icao!=='—'&&this.classList.contains('icao-cell')){
        e.preventDefault();e.stopPropagation();
        showWeatherModal(icao);
      }else if(!touchMoved&&touchDuration<=500&&!this.querySelector('input')){startEdit(this)}
    });
    cell.addEventListener('contextmenu',e=>{e.preventDefault();const icao=cell.dataset.icao;if(icao&&icao!=='—'&&cell.classList.contains('icao-cell'))showWeatherModal(icao)});
  });
}
function startEdit(cell){
  if(cell.querySelector('input'))return;
  const idx=parseInt(cell.dataset.idx,10);
  const field=cell.dataset.field;
  const currentValue=flights[idx][field];
  const input=document.createElement('input');
  input.type='text';
  if(field==='etd')input.value=formatZuluTime(currentValue)||'';
  else input.value=currentValue||'';
  const save=()=>{
    let newValue=input.value.trim();
    if(['origin','dest','takeoffAlt','alt1','alt2'].includes(field)&&newValue)newValue=normalizeICAO(newValue);
    if(field==='etd'&&newValue)newValue=normalizeTime(newValue.replace(/:/g,''));
    flights[idx][field]=newValue;
    if(['etd'].includes(field))calculateDurationAndETA(flights[idx]);
    renderTable();
    refreshWeather();
  };
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'){e.preventDefault();save()}
    else if(e.key==='Escape'){renderTable()}
  });
  input.addEventListener('blur',save);
  cell.innerHTML='';
  cell.appendChild(input);
  input.focus();
  input.select();
}
function updateStats(){statTotal.textContent=flights.length}
function startAutoRefresh(){autoRefreshInterval=setInterval(refreshWeather,5*60*1000)}
function startAlwaysOnCheck(){alwaysOnCheckInterval=setInterval(()=>{checkWeatherTriggers();renderTable()},ALWAYS_ON_CHECK_INTERVAL)}
window.flightActions={
  delay(idx){
    showDelayModal(idx);
  }
};
startClock();
loadFlights();
renderTable();
if(flights.length>0)refreshWeather();
startAutoRefresh();
startAlwaysOnCheck();
applyTheme(getTheme());
})();
  </script>
</body>
</html>
