<!-- 11/05/25 backup --> 
<!DOCTYPE html>
<html lang="en">
<head><!-- 11/05/25 backup --> 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CieloTracker Pro – Flight Weather Monitor</title>

  <style>
    :root { 
      --bg:#f9fafb; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; 
      --brand:#0f5fff; --danger:#ef4444; --success:#10b981; --warning:#f59e0b;
      --trigger-bg:#ef4444; --trigger-text:#fff;
    }

    * { box-sizing:border-box; }

    body { 
      margin:0; 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif; 
      background:var(--bg); 
      color:var(--fg); 
      font-size:14px;
      min-width:320px;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    .theme-dark { 
      --bg:#0b0f14; --fg:#e5e7eb; --muted:#9ca3af; --border:#1f2937; 
      --trigger-bg:#7f1d1d; --trigger-text:#fca5a5;
    }

    header { 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      padding:12px 16px; 
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
      gap:12px;
      flex-shrink:0;
    }

    .header-left { 
      font-size:18px; 
      font-weight:600; 
      white-space:nowrap; 
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
      padding:4px 8px;
      border-radius:6px;
      transition:background 0.2s;
    }

    .header-left:hover {
      background:rgba(0,0,0,0.08);
    }

    .theme-dark .header-left:hover {
      background:rgba(255,255,255,0.08);
    }

    .header-center { 
      display:flex; 
      gap:16px; 
      font-size:13px; 
      color:var(--muted); 
      flex-wrap:wrap; 
      align-items:center; 
    }

    .stat-item { display:flex; align-items:center; gap:4px; }
    .stat-label { color:var(--muted); font-size:12px; }
    .stat-value { font-weight:600; font-size:13px; }

    .btn { 
      height:32px; 
      padding:0 16px; 
      border:none; 
      border-radius:6px; 
      background:var(--brand); 
      color:#fff; 
      font-weight:600; 
      cursor:pointer; 
      font-size:13px;
      transition:opacity 0.2s;
      white-space:nowrap;
    }

    .btn:hover { opacity:0.9; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }

    .btn-secondary { background:var(--muted); }
    .btn-success { background:var(--success); }

    #errorDisplay { 
      padding:12px 16px; 
      background:#fef2f2; 
      color:var(--danger); 
      border-left:4px solid var(--danger);
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:13px;
      flex-shrink:0;
    }
    .theme-dark #errorDisplay { background:#7f1d1d; color:#fca5a5; }
    #errorDisplay.hidden { display:none !important; }

    main { 
      flex:1; 
      overflow-y:auto; 
      padding:16px;
    }

    .table-container { 
      background:#fff; 
      border:1px solid var(--border); 
      border-radius:8px; 
      overflow:hidden;
    }
    .theme-dark .table-container { background:#1a1f28; }

    table { 
      width:100%; 
      border-collapse:collapse; 
      font-size:13px;
    }

    thead { 
      background:#f3f4f6; 
      position:sticky; 
      top:0; 
      z-index:10;
    }
    .theme-dark thead { background:#0f1419; }

    th { 
      padding:10px 12px; 
      text-align:left; 
      font-weight:600; 
      color:var(--muted); 
      border-bottom:1px solid var(--border); 
      white-space:nowrap;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    td { 
      padding:10px 12px; 
      border-bottom:1px solid var(--border); 
      white-space:nowrap;
    }

    tbody tr:hover { background:#f9fafb; }
    .theme-dark tbody tr:hover { background:#0f1419; }

    .trigger-row { 
      background:var(--trigger-bg) !important; 
      color:var(--trigger-text) !important; 
      font-weight:600;
    }

    .trigger-row td { border-bottom-color:rgba(0,0,0,0.1); }
    .theme-dark .trigger-row td { border-bottom-color:rgba(255,255,255,0.1); }

    .status-badge { 
      display:inline-block; 
      padding:3px 8px; 
      border-radius:4px; 
      font-size:11px; 
      font-weight:600; 
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .status-scheduled { background:#dbeafe; color:#1e40af; }
    .status-out { background:#fef3c7; color:#92400e; }
    .status-off { background:#d1fae5; color:#065f46; }
    .status-on { background:#e0e7ff; color:#3730a3; }
    .status-in { background:#e5e7eb; color:#374151; }

    .theme-dark .status-scheduled { background:#1e3a8a; color:#93c5fd; }
    .theme-dark .status-out { background:#78350f; color:#fcd34d; }
    .theme-dark .status-off { background:#064e3b; color:#6ee7b7; }
    .theme-dark .status-on { background:#312e81; color:#a5b4fc; }
    .theme-dark .status-in { background:#1f2937; color:#d1d5db; }

    .airport-cell { 
      font-weight:600; 
      font-family:'Courier New',monospace;
    }

    .airport-dest-alt-required {
      background: #ef4444;
      color: #fff;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .airport-dest-alt-listed {
      color: #f59e0b;
      font-weight: 700;
    }

    .time-cell { 
      font-family:'Courier New',monospace; 
      color:var(--muted);
      font-size:12px;
    }

    .clickable { 
      cursor:pointer; 
      color:var(--brand); 
      text-decoration:underline;
      transition:opacity 0.2s;
    }

    .clickable:hover { opacity:0.7; }

    .modal-overlay { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.5); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:1000; 
      padding:16px;
    }

    .modal { 
      background:#fff; 
      border-radius:8px; 
      max-width:800px; 
      width:100%; 
      max-height:90vh; 
      display:flex; 
      flex-direction:column;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    .theme-dark .modal { background:#1a1f28; }

    .modal-header { 
      padding:16px 20px; 
      border-bottom:1px solid var(--border); 
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      flex-shrink:0;
    }

    .modal-title { 
      font-size:18px; 
      font-weight:600; 
      font-family:'Courier New',monospace;
    }

    .modal-close { 
      background:none; 
      border:none; 
      font-size:24px; 
      cursor:pointer; 
      color:var(--muted); 
      padding:0; 
      width:32px; 
      height:32px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      border-radius:4px;
      transition:background 0.2s;
    }

    .modal-close:hover { background:var(--border); }

    .modal-body { 
      padding:20px; 
      overflow-y:auto; 
      flex:1;
    }

    .wx-section { 
      margin-bottom:20px;
    }

    .wx-section:last-child { 
      margin-bottom:0;
    }

    .wx-label { 
      font-weight:600; 
      color:var(--muted); 
      margin-bottom:8px; 
      font-size:12px; 
      text-transform:uppercase; 
      letter-spacing:0.5px;
    }

    .wx-content { 
      background:var(--bg); 
      padding:12px; 
      border-radius:6px; 
      font-family:'Courier New',monospace; 
      font-size:13px; 
      line-height:1.6; 
      white-space:pre-wrap; 
      word-break:break-word;
      border:1px solid var(--border);
    }

    .loading { 
      text-align:center; 
      padding:40px; 
      color:var(--muted);
    }

    .spinner { 
      border:3px solid var(--border); 
      border-top-color:var(--brand); 
      border-radius:50%; 
      width:40px; 
      height:40px; 
      animation:spin 0.8s linear infinite; 
      margin:0 auto 16px;
    }

    @keyframes spin { 
      to { transform:rotate(360deg); } 
    }

    @media (max-width:768px) {
      header { 
        flex-direction:column; 
        align-items:stretch;
      }
      .header-center { 
        justify-content:space-between;
      }
      .table-container { 
        overflow-x:auto;
      }
      table { 
        min-width:800px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left" onclick="location.reload()">CieloTracker Pro</div>
  <div class="header-center">
    <div class="stat-item">
      <span class="stat-label">Total Flights:</span>
      <span class="stat-value" id="totalFlights">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Triggers:</span>
      <span class="stat-value" id="triggerCount" style="color:var(--danger)">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Last Update:</span>
      <span class="stat-value" id="lastUpdate">--:--</span>
    </div>
  </div>
  <button class="btn" id="refreshBtn" onclick="fetchFlights()">Refresh</button>
</header>

<div id="errorDisplay" class="hidden"></div>

<main>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Flight</th>
          <th>Status</th>
          <th>Origin</th>
          <th>Dest</th>
          <th>Alt1</th>
          <th>Alt2</th>
          <th>OUT</th>
          <th>OFF</th>
          <th>ON</th>
          <th>IN</th>
          <th>ETA</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody id="flightTableBody">
        <tr>
          <td colspan="12" class="loading">
            <div class="spinner"></div>
            <div>Loading flight data...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<div id="wxModal" class="modal-overlay" style="display:none" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">KJFK</div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading weather data...</div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://beta.flightaware.com/api/flights';
const WX_API_BASE = 'https://aviationweather.gov/cgi-bin/data/';

let flightsData = [];
let wxCache = {};

async function fetchFlights() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = 'Loading...';
  hideError();

  try {
    const response = await fetch(API_BASE);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const html = await response.text();
    flightsData = parseFlights(html);

    await fetchAllWeatherData();
    renderTable();
    updateStats();

    btn.textContent = 'Refresh';
  } catch (error) {
    showError(`Failed to load flights: ${error.message}`);
    btn.textContent = 'Retry';
  } finally {
    btn.disabled = false;
  }
}

function parseFlights(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const rows = doc.querySelectorAll('tr.data-row');

  return Array.from(rows).map(row => {
    const cells = row.querySelectorAll('td');
    return {
      ident: cells[0]?.textContent.trim() || '',
      status: cells[1]?.textContent.trim() || '',
      origin: cells[2]?.textContent.trim() || '',
      dest: cells[3]?.textContent.trim() || '',
      alt1: cells[4]?.textContent.trim() || '',
      alt2: cells[5]?.textContent.trim() || '',
      out: cells[6]?.textContent.trim() || '',
      off: cells[7]?.textContent.trim() || '',
      on: cells[8]?.textContent.trim() || '',
      in: cells[9]?.textContent.trim() || '',
      eta: cells[10]?.textContent.trim() || '',
      duration: cells[11]?.textContent.trim() || ''
    };
  });
}

async function fetchAllWeatherData() {
  const airports = new Set();
  flightsData.forEach(flight => {
    if (flight.origin) airports.add(flight.origin);
    if (flight.dest) airports.add(flight.dest);
    if (flight.alt1) airports.add(flight.alt1);
    if (flight.alt2) airports.add(flight.alt2);
  });

  const promises = Array.from(airports).map(async icao => {
    if (!wxCache[icao]) {
      wxCache[icao] = {
        metar: await fetchWeather('metar', icao),
        taf: await fetchWeather('taf', icao)
      };
    }
  });

  await Promise.all(promises);
}

async function fetchWeather(type, icao) {
  try {
    const url = `${WX_API_BASE}${type}.php?ids=${icao}&format=raw&hours=0&taf=2`;
    const response = await fetch(url);
    if (!response.ok) return '';
    const text = await response.text();
    return text.trim();
  } catch {
    return '';
  }
}

function parseDuration(durationStr) {
  if (!durationStr) return 0;
  const match = durationStr.match(/(\d+):(\d+)/);
  if (!match) return 0;
  return parseInt(match[1]) * 60 + parseInt(match[2]);
}

function checkAlternateRequirement(flight) {
  const destWx = wxCache[flight.dest];
  if (!destWx) return false;

  const terms = ['TSRA', 'VCTS', 'FZRA', 'FZDZ', '+SN', 'PSN', 'FZFG', 'GR', 'UP', 'TS'];

  if (!flight.eta) return false;

  const etaMatch = flight.eta.match(/(\d{2}):(\d{2})/);
  if (!etaMatch) return false;
  const etaHour = parseInt(etaMatch[1]);

  const durationMinutes = parseDuration(flight.duration);

  // Duration < 60 minutes: check BOTH METAR AND TAF
  // Duration >= 60 minutes: check ONLY TAF
  if (durationMinutes < 60) {
    // Check METAR
    if (destWx.metar) {
      for (const term of terms) {
        if (destWx.metar.includes(term)) {
          return true;
        }
      }
    }
  }

  // Always check TAF (for both cases)
  if (destWx.taf) {
    const lines = destWx.taf.split('\n');
    for (const line of lines) {
      const timeMatch = line.match(/FM(\d{2})(\d{2})|(\d{2})(\d{2})\/(\d{2})(\d{2})/);
      if (timeMatch) {
        let lineHour;
        if (timeMatch[1]) {
          lineHour = parseInt(timeMatch[1]);
        } else if (timeMatch[3]) {
          lineHour = parseInt(timeMatch[3]);
        }

        if (lineHour === etaHour) {
          for (const term of terms) {
            if (line.includes(term)) {
              return true;
            }
          }
        }
      }
    }
  }

  return false;
}

function checkMissingMetarElements(flight) {
  const checkAirport = (icao) => {
    if (!icao) return false;
    const wx = wxCache[icao];
    if (!wx || !wx.metar) return true;

    const metar = wx.metar.trim();
    if (metar === '') return true;

    const hasWind = /\d{3}\d{2}(G\d{2})?KT|VRB\d{2}KT|\d{3}V\d{3}/.test(metar);
    const hasVis = /\d+SM|\d{4}|CAVOK|P6SM|M1\/4SM/.test(metar);
    const hasSkyConditions = /\b(SKC|CLR|FEW|SCT|BKN|OVC|VV)\d{3}/.test(metar);
    const hasTemp = /\s(M?\d{2})\/(M?\d{2})/.test(metar);
    const hasAltimeter = /A\d{4}|Q\d{4}/.test(metar);

    return !(hasWind && hasVis && hasSkyConditions && hasTemp && hasAltimeter);
  };

  return checkAirport(flight.origin) || checkAirport(flight.dest);
}

function checkLowCeilingVisibility(flight) {
  if (flight.status.toLowerCase() !== 'out') return false;

  const destWx = wxCache[flight.dest];
  if (!destWx || !destWx.metar) return false;

  const metar = destWx.metar;

  const ceilingMatch = metar.match(/\b(BKN|OVC)(\d{3})\b/g);
  if (ceilingMatch) {
    for (const match of ceilingMatch) {
      const height = parseInt(match.slice(-3));
      if (height <= 2) return true;
    }
  }

  const visMatch = metar.match(/\b(\d+\/\d+|\d+)SM\b/);
  if (visMatch) {
    const visStr = visMatch[1];
    let visMiles;

    if (visStr.includes('/')) {
      const [num, den] = visStr.split('/').map(Number);
      visMiles = num / den;
    } else {
      visMiles = parseFloat(visStr);
    }

    if (visMiles <= 0.5) return true;
  }

  return false;
}

function getMetarIndicators(flight) {
  let indicators = '';

  const checkAirport = (icao) => {
    if (!icao) return false;
    const wx = wxCache[icao];
    if (!wx || !wx.metar) return true;

    const metar = wx.metar.trim();
    if (metar === '') return true;

    const hasWind = /\d{3}\d{2}(G\d{2})?KT|VRB\d{2}KT|\d{3}V\d{3}/.test(metar);
    const hasVis = /\d+SM|\d{4}|CAVOK|P6SM|M1\/4SM/.test(metar);
    const hasSkyConditions = /\b(SKC|CLR|FEW|SCT|BKN|OVC|VV)\d{3}/.test(metar);
    const hasTemp = /\s(M?\d{2})\/(M?\d{2})/.test(metar);
    const hasAltimeter = /A\d{4}|Q\d{4}/.test(metar);

    return !(hasWind && hasVis && hasSkyConditions && hasTemp && hasAltimeter);
  };

  if (checkAirport(flight.origin)) indicators += '?';
  if (checkAirport(flight.dest)) indicators += '?';

  if (checkLowCeilingVisibility(flight)) {
    indicators += '⚠';
  }

  if (checkAlternateRequirement(flight)) {
    indicators += '⚡';
  }

  return indicators;
}

function renderTable() {
  const tbody = document.getElementById('flightTableBody');

  if (flightsData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--muted)">No flights found</td></tr>';
    return;
  }

  tbody.innerHTML = flightsData.map(flight => {
    const isTrigger = checkMissingMetarElements(flight);
    const rowClass = isTrigger ? 'trigger-row' : '';
    const indicators = getMetarIndicators(flight);

    const altRequired = checkAlternateRequirement(flight);
    const hasAlternate = flight.alt1 || flight.alt2;

    let destClass = 'airport-cell';
    if (altRequired) {
      if (!hasAlternate) {
        destClass += ' airport-dest-alt-required';
      } else {
        destClass += ' airport-dest-alt-listed';
      }
    }

    return `
      <tr class="${rowClass}">
        <td style="font-weight:600">${flight.ident}</td>
        <td><span class="status-badge status-${flight.status.toLowerCase()}">${flight.status}</span></td>
        <td class="airport-cell clickable" onclick="showWeather('${flight.origin}')">${flight.origin}</td>
        <td class="${destClass} clickable" onclick="showWeather('${flight.dest}')">${flight.dest} ${indicators}</td>
        <td class="airport-cell ${flight.alt1 ? 'clickable' : ''}" ${flight.alt1 ? `onclick="showWeather('${flight.alt1}')"` : ''}>${flight.alt1 || '—'}</td>
        <td class="airport-cell ${flight.alt2 ? 'clickable' : ''}" ${flight.alt2 ? `onclick="showWeather('${flight.alt2}')"` : ''}>${flight.alt2 || '—'}</td>
        <td class="time-cell">${flight.out || '—'}</td>
        <td class="time-cell">${flight.off || '—'}</td>
        <td class="time-cell">${flight.on || '—'}</td>
        <td class="time-cell">${flight.in || '—'}</td>
        <td class="time-cell">${flight.eta || '—'}</td>
        <td class="time-cell">${flight.duration || '—'}</td>
      </tr>
    `;
  }).join('');
}

function updateStats() {
  document.getElementById('totalFlights').textContent = flightsData.length;

  const triggerCount = flightsData.filter(checkMissingMetarElements).length;
  document.getElementById('triggerCount').textContent = triggerCount;

  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: true 
  });
  document.getElementById('lastUpdate').textContent = timeStr;
}

function showWeather(icao) {
  const modal = document.getElementById('wxModal');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');

  title.textContent = icao;
  body.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading weather data...</div></div>';
  modal.style.display = 'flex';

  const wx = wxCache[icao];

  setTimeout(() => {
    body.innerHTML = `
      <div class="wx-section">
        <div class="wx-label">METAR</div>
        <div class="wx-content">${wx?.metar || 'No METAR available'}</div>
      </div>
      <div class="wx-section">
        <div class="wx-label">TAF</div>
        <div class="wx-content">${wx?.taf || 'No TAF available'}</div>
      </div>
    `;
  }, 300);
}

function closeModal(event) {
  if (!event || event.target.id === 'wxModal') {
    document.getElementById('wxModal').style.display = 'none';
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorDisplay');
  errorDiv.textContent = message;
  errorDiv.classList.remove('hidden');
}

function hideError() {
  document.getElementById('errorDisplay').classList.add('hidden');
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

fetchFlights();
setInterval(fetchFlights, 120000);
</script>

</body>
</html>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CieloTracker Pro – Flight Weather Monitor</title>

  <style>
    :root { 
      --bg:#f9fafb; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; 
      --brand:#0f5fff; --danger:#ef4444; --success:#10b981; --warning:#f59e0b;
      --trigger-bg:#ef4444; --trigger-text:#fff;
    }

    * { box-sizing:border-box; }

    body { 
      margin:0; 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif; 
      background:var(--bg); 
      color:var(--fg); 
      font-size:14px;
      min-width:320px;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    .theme-dark { 
      --bg:#0b0f14; --fg:#e5e7eb; --muted:#9ca3af; --border:#1f2937; 
      --trigger-bg:#7f1d1d; --trigger-text:#fca5a5;
    }

    header { 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      padding:12px 16px; 
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
      gap:12px;
      flex-shrink:0;
    }

    .header-left { 
      font-size:18px; 
      font-weight:600; 
      white-space:nowrap; 
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
      padding:4px 8px;
      border-radius:6px;
      transition:background 0.2s;
    }

    .header-left:hover {
      background:rgba(0,0,0,0.08);
    }

    .theme-dark .header-left:hover {
      background:rgba(255,255,255,0.08);
    }

    .header-center { 
      display:flex; 
      gap:16px; 
      font-size:13px; 
      color:var(--muted); 
      flex-wrap:wrap; 
      align-items:center; 
    }

    .stat-item { display:flex; align-items:center; gap:4px; }
    .stat-label { color:var(--muted); font-size:12px; }
    .stat-value { font-weight:600; font-size:13px; }

    .btn { 
      height:32px; 
      padding:0 16px; 
      border:none; 
      border-radius:6px; 
      background:var(--brand); 
      color:#fff; 
      font-weight:600; 
      cursor:pointer; 
      font-size:13px;
      transition:opacity 0.2s;
      white-space:nowrap;
    }

    .btn:hover { opacity:0.9; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }

    .btn-secondary { background:var(--muted); }
    .btn-success { background:var(--success); }

    #errorDisplay { 
      padding:12px 16px; 
      background:#fef2f2; 
      color:var(--danger); 
      border-left:4px solid var(--danger);
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:13px;
      flex-shrink:0;
    }
    .theme-dark #errorDisplay { background:#7f1d1d; color:#fca5a5; }
    #errorDisplay.hidden { display:none !important; }

    main { 
      flex:1; 
      overflow-y:auto; 
      padding:16px;
    }

    .table-container { 
      background:#fff; 
      border:1px solid var(--border); 
      border-radius:8px; 
      overflow:hidden;
    }
    .theme-dark .table-container { background:#1a1f28; }

    table { 
      width:100%; 
      border-collapse:collapse; 
      font-size:13px;
    }

    thead { 
      background:#f3f4f6; 
      position:sticky; 
      top:0; 
      z-index:10;
    }
    .theme-dark thead { background:#0f1419; }

    th { 
      padding:10px 12px; 
      text-align:left; 
      font-weight:600; 
      color:var(--muted); 
      border-bottom:1px solid var(--border); 
      white-space:nowrap;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    td { 
      padding:10px 12px; 
      border-bottom:1px solid var(--border); 
      white-space:nowrap;
    }

    tbody tr:hover { background:#f9fafb; }
    .theme-dark tbody tr:hover { background:#0f1419; }

    .trigger-row { 
      background:var(--trigger-bg) !important; 
      color:var(--trigger-text) !important; 
      font-weight:600;
    }

    .trigger-row td { border-bottom-color:rgba(0,0,0,0.1); }
    .theme-dark .trigger-row td { border-bottom-color:rgba(255,255,255,0.1); }

    .status-badge { 
      display:inline-block; 
      padding:3px 8px; 
      border-radius:4px; 
      font-size:11px; 
      font-weight:600; 
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .status-scheduled { background:#dbeafe; color:#1e40af; }
    .status-out { background:#fef3c7; color:#92400e; }
    .status-off { background:#d1fae5; color:#065f46; }
    .status-on { background:#e0e7ff; color:#3730a3; }
    .status-in { background:#e5e7eb; color:#374151; }

    .theme-dark .status-scheduled { background:#1e3a8a; color:#93c5fd; }
    .theme-dark .status-out { background:#78350f; color:#fcd34d; }
    .theme-dark .status-off { background:#064e3b; color:#6ee7b7; }
    .theme-dark .status-on { background:#312e81; color:#a5b4fc; }
    .theme-dark .status-in { background:#1f2937; color:#d1d5db; }

    .airport-cell { 
      font-weight:600; 
      font-family:'Courier New',monospace;
    }

    .airport-dest-alt-required {
      background: #ef4444;
      color: #fff;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .airport-dest-alt-listed {
      color: #f59e0b;
      font-weight: 700;
    }

    .time-cell { 
      font-family:'Courier New',monospace; 
      color:var(--muted);
      font-size:12px;
    }

    .clickable { 
      cursor:pointer; 
      color:var(--brand); 
      text-decoration:underline;
      transition:opacity 0.2s;
    }

    .clickable:hover { opacity:0.7; }

    .modal-overlay { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.5); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:1000; 
      padding:16px;
    }

    .modal { 
      background:#fff; 
      border-radius:8px; 
      max-width:800px; 
      width:100%; 
      max-height:90vh; 
      display:flex; 
      flex-direction:column;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    .theme-dark .modal { background:#1a1f28; }

    .modal-header { 
      padding:16px 20px; 
      border-bottom:1px solid var(--border); 
      display:flex; 
      align-items:center; 
      justify-content:space-between;
      flex-shrink:0;
    }

    .modal-title { 
      font-size:18px; 
      font-weight:600; 
      font-family:'Courier New',monospace;
    }

    .modal-close { 
      background:none; 
      border:none; 
      font-size:24px; 
      cursor:pointer; 
      color:var(--muted); 
      padding:0; 
      width:32px; 
      height:32px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      border-radius:4px;
      transition:background 0.2s;
    }

    .modal-close:hover { background:var(--border); }

    .modal-body { 
      padding:20px; 
      overflow-y:auto; 
      flex:1;
    }

    .wx-section { 
      margin-bottom:20px;
    }

    .wx-section:last-child { 
      margin-bottom:0;
    }

    .wx-label { 
      font-weight:600; 
      color:var(--muted); 
      margin-bottom:8px; 
      font-size:12px; 
      text-transform:uppercase; 
      letter-spacing:0.5px;
    }

    .wx-content { 
      background:var(--bg); 
      padding:12px; 
      border-radius:6px; 
      font-family:'Courier New',monospace; 
      font-size:13px; 
      line-height:1.6; 
      white-space:pre-wrap; 
      word-break:break-word;
      border:1px solid var(--border);
    }

    .loading { 
      text-align:center; 
      padding:40px; 
      color:var(--muted);
    }

    .spinner { 
      border:3px solid var(--border); 
      border-top-color:var(--brand); 
      border-radius:50%; 
      width:40px; 
      height:40px; 
      animation:spin 0.8s linear infinite; 
      margin:0 auto 16px;
    }

    @keyframes spin { 
      to { transform:rotate(360deg); } 
    }

    @media (max-width:768px) {
      header { 
        flex-direction:column; 
        align-items:stretch;
      }
      .header-center { 
        justify-content:space-between;
      }
      .table-container { 
        overflow-x:auto;
      }
      table { 
        min-width:800px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left" onclick="location.reload()">CieloTracker Pro</div>
  <div class="header-center">
    <div class="stat-item">
      <span class="stat-label">Total Flights:</span>
      <span class="stat-value" id="totalFlights">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Triggers:</span>
      <span class="stat-value" id="triggerCount" style="color:var(--danger)">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Last Update:</span>
      <span class="stat-value" id="lastUpdate">--:--</span>
    </div>
  </div>
  <button class="btn" id="refreshBtn" onclick="fetchFlights()">Refresh</button>
</header>

<div id="errorDisplay" class="hidden"></div>

<main>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Flight</th>
          <th>Status</th>
          <th>Origin</th>
          <th>Dest</th>
          <th>Alt1</th>
          <th>Alt2</th>
          <th>OUT</th>
          <th>OFF</th>
          <th>ON</th>
          <th>IN</th>
          <th>ETA</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody id="flightTableBody">
        <tr>
          <td colspan="12" class="loading">
            <div class="spinner"></div>
            <div>Loading flight data...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<div id="wxModal" class="modal-overlay" style="display:none" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">KJFK</div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading weather data...</div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://beta.flightaware.com/api/flights';
const WX_API_BASE = 'https://aviationweather.gov/cgi-bin/data/';

let flightsData = [];
let wxCache = {};

async function fetchFlights() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = 'Loading...';
  hideError();

  try {
    const response = await fetch(API_BASE);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const html = await response.text();
    flightsData = parseFlights(html);

    await fetchAllWeatherData();
    renderTable();
    updateStats();

    btn.textContent = 'Refresh';
  } catch (error) {
    showError(`Failed to load flights: ${error.message}`);
    btn.textContent = 'Retry';
  } finally {
    btn.disabled = false;
  }
}

function parseFlights(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const rows = doc.querySelectorAll('tr.data-row');

  return Array.from(rows).map(row => {
    const cells = row.querySelectorAll('td');
    return {
      ident: cells[0]?.textContent.trim() || '',
      status: cells[1]?.textContent.trim() || '',
      origin: cells[2]?.textContent.trim() || '',
      dest: cells[3]?.textContent.trim() || '',
      alt1: cells[4]?.textContent.trim() || '',
      alt2: cells[5]?.textContent.trim() || '',
      out: cells[6]?.textContent.trim() || '',
      off: cells[7]?.textContent.trim() || '',
      on: cells[8]?.textContent.trim() || '',
      in: cells[9]?.textContent.trim() || '',
      eta: cells[10]?.textContent.trim() || '',
      duration: cells[11]?.textContent.trim() || ''
    };
  });
}

async function fetchAllWeatherData() {
  const airports = new Set();
  flightsData.forEach(flight => {
    if (flight.origin) airports.add(flight.origin);
    if (flight.dest) airports.add(flight.dest);
    if (flight.alt1) airports.add(flight.alt1);
    if (flight.alt2) airports.add(flight.alt2);
  });

  const promises = Array.from(airports).map(async icao => {
    if (!wxCache[icao]) {
      wxCache[icao] = {
        metar: await fetchWeather('metar', icao),
        taf: await fetchWeather('taf', icao)
      };
    }
  });

  await Promise.all(promises);
}

async function fetchWeather(type, icao) {
  try {
    const url = `${WX_API_BASE}${type}.php?ids=${icao}&format=raw&hours=0&taf=2`;
    const response = await fetch(url);
    if (!response.ok) return '';
    const text = await response.text();
    return text.trim();
  } catch {
    return '';
  }
}

function parseDuration(durationStr) {
  if (!durationStr) return 0;
  const match = durationStr.match(/(\d+):(\d+)/);
  if (!match) return 0;
  return parseInt(match[1]) * 60 + parseInt(match[2]);
}

function checkAlternateRequirement(flight) {
  const destWx = wxCache[flight.dest];
  if (!destWx) return false;

  const terms = ['TSRA', 'VCTS', 'FZRA', 'FZDZ', '+SN', 'PSN', 'FZFG', 'GR', 'UP', 'TS'];

  if (!flight.eta) return false;

  const etaMatch = flight.eta.match(/(\d{2}):(\d{2})/);
  if (!etaMatch) return false;
  const etaHour = parseInt(etaMatch[1]);

  const durationMinutes = parseDuration(flight.duration);

  // Duration < 60 minutes: check BOTH METAR AND TAF
  // Duration >= 60 minutes: check ONLY TAF
  if (durationMinutes < 60) {
    // Check METAR
    if (destWx.metar) {
      for (const term of terms) {
        if (destWx.metar.includes(term)) {
          return true;
        }
      }
    }
  }

  // Always check TAF (for both cases)
  if (destWx.taf) {
    const lines = destWx.taf.split('\n');
    for (const line of lines) {
      const timeMatch = line.match(/FM(\d{2})(\d{2})|(\d{2})(\d{2})\/(\d{2})(\d{2})/);
      if (timeMatch) {
        let lineHour;
        if (timeMatch[1]) {
          lineHour = parseInt(timeMatch[1]);
        } else if (timeMatch[3]) {
          lineHour = parseInt(timeMatch[3]);
        }

        if (lineHour === etaHour) {
          for (const term of terms) {
            if (line.includes(term)) {
              return true;
            }
          }
        }
      }
    }
  }

  return false;
}

function checkMissingMetarElements(flight) {
  const checkAirport = (icao) => {
    if (!icao) return false;
    const wx = wxCache[icao];
    if (!wx || !wx.metar) return true;

    const metar = wx.metar.trim();
    if (metar === '') return true;

    const hasWind = /\d{3}\d{2}(G\d{2})?KT|VRB\d{2}KT|\d{3}V\d{3}/.test(metar);
    const hasVis = /\d+SM|\d{4}|CAVOK|P6SM|M1\/4SM/.test(metar);
    const hasSkyConditions = /\b(SKC|CLR|FEW|SCT|BKN|OVC|VV)\d{3}/.test(metar);
    const hasTemp = /\s(M?\d{2})\/(M?\d{2})/.test(metar);
    const hasAltimeter = /A\d{4}|Q\d{4}/.test(metar);

    return !(hasWind && hasVis && hasSkyConditions && hasTemp && hasAltimeter);
  };

  return checkAirport(flight.origin) || checkAirport(flight.dest);
}

function checkLowCeilingVisibility(flight) {
  if (flight.status.toLowerCase() !== 'out') return false;

  const destWx = wxCache[flight.dest];
  if (!destWx || !destWx.metar) return false;

  const metar = destWx.metar;

  const ceilingMatch = metar.match(/\b(BKN|OVC)(\d{3})\b/g);
  if (ceilingMatch) {
    for (const match of ceilingMatch) {
      const height = parseInt(match.slice(-3));
      if (height <= 2) return true;
    }
  }

  const visMatch = metar.match(/\b(\d+\/\d+|\d+)SM\b/);
  if (visMatch) {
    const visStr = visMatch[1];
    let visMiles;

    if (visStr.includes('/')) {
      const [num, den] = visStr.split('/').map(Number);
      visMiles = num / den;
    } else {
      visMiles = parseFloat(visStr);
    }

    if (visMiles <= 0.5) return true;
  }

  return false;
}

function getMetarIndicators(flight) {
  let indicators = '';

  const checkAirport = (icao) => {
    if (!icao) return false;
    const wx = wxCache[icao];
    if (!wx || !wx.metar) return true;

    const metar = wx.metar.trim();
    if (metar === '') return true;

    const hasWind = /\d{3}\d{2}(G\d{2})?KT|VRB\d{2}KT|\d{3}V\d{3}/.test(metar);
    const hasVis = /\d+SM|\d{4}|CAVOK|P6SM|M1\/4SM/.test(metar);
    const hasSkyConditions = /\b(SKC|CLR|FEW|SCT|BKN|OVC|VV)\d{3}/.test(metar);
    const hasTemp = /\s(M?\d{2})\/(M?\d{2})/.test(metar);
    const hasAltimeter = /A\d{4}|Q\d{4}/.test(metar);

    return !(hasWind && hasVis && hasSkyConditions && hasTemp && hasAltimeter);
  };

  if (checkAirport(flight.origin)) indicators += '?';
  if (checkAirport(flight.dest)) indicators += '?';

  if (checkLowCeilingVisibility(flight)) {
    indicators += '⚠';
  }

  if (checkAlternateRequirement(flight)) {
    indicators += '⚡';
  }

  return indicators;
}

function renderTable() {
  const tbody = document.getElementById('flightTableBody');

  if (flightsData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--muted)">No flights found</td></tr>';
    return;
  }

  tbody.innerHTML = flightsData.map(flight => {
    const isTrigger = checkMissingMetarElements(flight);
    const rowClass = isTrigger ? 'trigger-row' : '';
    const indicators = getMetarIndicators(flight);

    const altRequired = checkAlternateRequirement(flight);
    const hasAlternate = flight.alt1 || flight.alt2;

    let destClass = 'airport-cell';
    if (altRequired) {
      if (!hasAlternate) {
        destClass += ' airport-dest-alt-required';
      } else {
        destClass += ' airport-dest-alt-listed';
      }
    }

    return `
      <tr class="${rowClass}">
        <td style="font-weight:600">${flight.ident}</td>
        <td><span class="status-badge status-${flight.status.toLowerCase()}">${flight.status}</span></td>
        <td class="airport-cell clickable" onclick="showWeather('${flight.origin}')">${flight.origin}</td>
        <td class="${destClass} clickable" onclick="showWeather('${flight.dest}')">${flight.dest} ${indicators}</td>
        <td class="airport-cell ${flight.alt1 ? 'clickable' : ''}" ${flight.alt1 ? `onclick="showWeather('${flight.alt1}')"` : ''}>${flight.alt1 || '—'}</td>
        <td class="airport-cell ${flight.alt2 ? 'clickable' : ''}" ${flight.alt2 ? `onclick="showWeather('${flight.alt2}')"` : ''}>${flight.alt2 || '—'}</td>
        <td class="time-cell">${flight.out || '—'}</td>
        <td class="time-cell">${flight.off || '—'}</td>
        <td class="time-cell">${flight.on || '—'}</td>
        <td class="time-cell">${flight.in || '—'}</td>
        <td class="time-cell">${flight.eta || '—'}</td>
        <td class="time-cell">${flight.duration || '—'}</td>
      </tr>
    `;
  }).join('');
}

function updateStats() {
  document.getElementById('totalFlights').textContent = flightsData.length;

  const triggerCount = flightsData.filter(checkMissingMetarElements).length;
  document.getElementById('triggerCount').textContent = triggerCount;

  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: true 
  });
  document.getElementById('lastUpdate').textContent = timeStr;
}

function showWeather(icao) {
  const modal = document.getElementById('wxModal');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');

  title.textContent = icao;
  body.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading weather data...</div></div>';
  modal.style.display = 'flex';

  const wx = wxCache[icao];

  setTimeout(() => {
    body.innerHTML = `
      <div class="wx-section">
        <div class="wx-label">METAR</div>
        <div class="wx-content">${wx?.metar || 'No METAR available'}</div>
      </div>
      <div class="wx-section">
        <div class="wx-label">TAF</div>
        <div class="wx-content">${wx?.taf || 'No TAF available'}</div>
      </div>
    `;
  }, 300);
}

function closeModal(event) {
  if (!event || event.target.id === 'wxModal') {
    document.getElementById('wxModal').style.display = 'none';
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorDisplay');
  errorDiv.textContent = message;
  errorDiv.classList.remove('hidden');
}

function hideError() {
  document.getElementById('errorDisplay').classList.add('hidden');
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

fetchFlights();
setInterval(fetchFlights, 120000);
</script>

</body>
</html>
