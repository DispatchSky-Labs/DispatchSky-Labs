<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CieloTracker Pro – Quick Load</title>
<style>
  :root { --bg:#f9fafb; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --brand:#0f5fff; --danger:#ef4444; --success:#10b981; }
  body { margin:0; font-family:system-ui,sans-serif; background:var(--bg); color:var(--fg); display:flex; flex-direction:column; height:100vh; font-size:14px; min-width:320px; }
  header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); }
  .header-left { font-size:18px; font-weight:600; cursor:pointer; user-select:none; }
  .header-center { display:flex; gap:16px; font-size:13px; color:var(--muted); align-items:center; }
  .stat-label { color:var(--muted); font-size:12px; } .stat-value { font-weight:600; font-size:13px; }
  .btn { height:32px; padding:0 16px; border:none; border-radius:6px; background:var(--brand); color:#fff; font-weight:600; cursor:pointer; font-size:13px; }
  .btn:hover { opacity:0.9; }
  .btn-secondary { background:var(--muted); } .btn-success { background:var(--success); }
  .table-wrapper { flex:1; overflow:hidden; display:flex; flex-direction:column; }
  .table-container { flex:1; overflow:auto; }
  table { width:100%; border-collapse:collapse; background:#fff; font-size:13px; }
  th, td { padding:6px 4px; border-bottom:1px solid var(--border); white-space:nowrap; }
  tbody tr:hover { background:#dbeafe; }
  .flt-cell { cursor:pointer; user-select:none; }
  .taxi-burn-cell { cursor:pointer; font-style:italic; }
  .editable { cursor:text; min-width:40px; padding:4px; border-radius:4px; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<header>
  <div class="header-left" id="headerTitle">CieloTracker <strong>Pro</strong></div>
  <div class="header-center">
    <span id="currentTime">--:-- UTC</span>
    <span id="lastUpdate">Updated: --:-- UTC</span>
    <div class="stat-item"><span class="stat-label">Total:</span><span class="stat-value" id="statTotal">0</span></div>
  </div>
</header>

<div id="errorDisplay" class="hidden">⚠️ Weather data unavailable.</div>

<div class="table-wrapper">
  <div class="table-container">
    <table id="flightTable">
      <thead>
        <tr>
          <th>FLT</th><th>ORG</th><th>DEST</th><th>T/ALT</th><th>ALT1</th><th>ALT2</th>
          <th>ETD</th><th>TAXI</th><th>BURN</th><th>DUR</th><th>ETA</th><th>Actions</th><th></th>
        </tr>
      </thead>
      <tbody id="flightTableBody">
        <tr><td colspan="13" class="loading">Left-click CieloTracker to upload flights</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  'use strict';
  const flights = [], weatherData = {};
  let autoRefreshInterval = null;
  const $ = s=>document.querySelector(s);
  const flightTableBody = $('#flightTableBody');
  const currentTimeEl = $('#currentTime');
  const lastUpdateEl = $('#lastUpdate');
  const statTotal = $('#statTotal');
  const headerTitle = $('#headerTitle');

  function pad2(n){return String(n).padStart(2,'0');}
  function getCurrentZulu(){const now=new Date();return pad2(now.getUTCHours())+pad2(now.getUTCMinutes());}
  function formatDuration(min){if(!min&&min!==0)return'';const m=parseInt(min,10);if(isNaN(m))return'';return pad2(Math.floor(m/60))+pad2(m%60);}
  function formatZuluTime(hhmm){return hhmm&&hhmm.length===4?hhmm.slice(0,2)+':'+hhmm.slice(2):hhmm||'';}

  function renderTable(){
    if(!flights.length){
      flightTableBody.innerHTML='<tr><td colspan="13" class="loading">Left-click CieloTracker to upload flights</td></tr>';
      statTotal.textContent=0;
      return;
    }
    flightTableBody.innerHTML='';
    flights.forEach((f,i)=>{
      const row=document.createElement('tr');
      row.innerHTML=`<td class="flt-cell" data-idx="${i}">${f.flight}</td>
        <td class="editable" data-idx="${i}" data-field="origin">${f.origin||''}</td>
        <td class="editable" data-idx="${i}" data-field="dest">${f.dest||''}</td>
        <td class="editable" data-idx="${i}" data-field="takeoffAlt">${f.takeoffAlt||''}</td>
        <td class="editable" data-idx="${i}" data-field="alt1">${f.alt1||''}</td>
        <td class="editable" data-idx="${i}" data-field="alt2">${f.alt2||''}</td>
        <td class="editable" data-idx="${i}" data-field="etd">${f.etd||''}</td>
        <td class="taxi-burn-cell" data-idx="${i}" data-field="taxiOut">${formatDuration(f.taxiOut)}</td>
        <td class="taxi-burn-cell" data-idx="${i}" data-field="burnoff">${formatDuration(f.burnoff)}</td>
        <td>${formatDuration(f.duration)}</td>
        <td>${formatZuluTime(f.eta)}</td>
        <td style="white-space:nowrap;">
          ${f.phase==='planned'?`<button class="btn btn-secondary" onclick="window.flightActions.markSent(${i})">Sent</button>`:''}
          ${f.phase==='sent'?`<button class="btn btn-secondary" onclick="window.flightActions.markOut(${i})">Out</button>`:''}
          <button class="btn btn-secondary" onclick="window.flightActions.remove(${i})">×</button>
        </td><td></td>`;
      flightTableBody.appendChild(row);
    });
    statTotal.textContent=flights.length;
  }

  function updateClock(){
    const now=new Date();
    currentTimeEl.textContent=`${pad2(now.getUTCHours())}:${pad2(now.getUTCMinutes())} UTC`;
  }
  setInterval(updateClock,60000); updateClock();

  function startAutoRefresh(){
    if(autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval=setInterval(()=>{ /* temp: skip heavy triggers */ renderTable(); },60000);
  }

  window.flightActions={
    markSent(idx){flights[idx].phase='sent'; renderTable();},
    markOut(idx){flights[idx].phase='out'; flights[idx].outTime=getCurrentZulu(); renderTable();},
    remove(idx){flights.splice(idx,1); renderTable();}
  };

  headerTitle.addEventListener('click',e=>{e.preventDefault(); alert('Context menu placeholder');});

  // Quick test data
  flights.push({flight:'5002',origin:'ORD',dest:'LEX',etd:'2218',eta:'2345',taxiOut:'15',burnoff:'120',duration:'135',phase:'planned',takeoffAlt:'',alt1:'',alt2:''});
  flights.push({flight:'5004',origin:'DEN',dest:'ATL',etd:'0345',eta:'0715',taxiOut:'20',burnoff:'180',duration:'200',phase:'planned',takeoffAlt:'',alt1:'',alt2:''});

  renderTable();
  startAutoRefresh();
})();
</script>
</body>
</html>
