<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CieloTracker — METAR/TAF Monitor</title>
  <meta name="description" content="Sadiom METAR/TAF monitor with backend-rendered highlighting and triggers." />

  <style>
    :root{
      --fg:#0b0b0b; --bg:#ffffff; --card:#f7f7f7; --muted:#666; --ink:#0b6;
      --warn:#b00020; --panel:#ffffff; --rule:#e9e9e9;
    }
    .theme-dark{
      --fg:#eaeaea; --bg:#0b0b0b; --card:#11151a; --muted:#a1a1a1; --ink:#59c3ff;
      --warn:#ff6b6b; --panel:#0f141a; --rule:#20252b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      display:flex; flex-direction:column; min-height:100vh;
    }
    a{color:var(--ink)}
    header{background:#0b2239; color:#fff; padding:16px 20px}
    header h1{margin:0 0 4px; font-size:20px}
    header p{margin:0; opacity:.9; font-size:14px}
    .hdr-line{display:flex; align-items:flex-end; justify-content:space-between; gap:12px}
    .utc{font-variant-numeric:tabular-nums; opacity:.9; font-size:14px}

    nav.top{max-width:1200px; margin:0 auto; padding:8px 12px; display:flex; gap:14px}
    nav.top a{color:#cfe8ff; text-decoration:none; font-size:14px}
    nav.top a:hover{text-decoration:underline}

    main{flex:1; max-width:1200px; margin:18px auto; padding:0 12px 32px}
    .toolbar{
      background:var(--card); border:1px solid var(--rule); border-radius:12px; padding:14px; display:flex; flex-wrap:wrap; gap:12px; align-items:center;
    }
    .toolbar .group{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{font-size:14px; color:var(--fg); display:flex; align-items:center; gap:6px}
    input[type="text"], input[type="number"], select{
      padding:8px 10px; border:1px solid var(--rule); background:#fff; border-radius:8px; min-width:120px; font-size:14px;
    }
    .theme-dark input[type="text"], .theme-dark input[type="number"], .theme-dark select {
      background:#0e1216; color:var(--fg); border-color:#222a31;
    }
    .switch{display:inline-flex; align-items:center; gap:6px; cursor:pointer}
    .switch input{accent-color:var(--ink); width:18px; height:18px}
    .error{
      display:none; margin-top:12px; padding:10px; border-radius:8px;
      color:#7a0000; background:#ffe9e9; border:1px solid #f3bcbc; white-space:pre-wrap;
    }
    .theme-dark .error{color:#300; background:#3b0000; border-color:#5b2222}

    .board{margin-top:14px; background:var(--card); border:1px solid var(--rule); border-radius:12px; overflow:hidden}
    .board-header{padding:10px 12px; border-bottom:1px solid var(--rule); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap}
    .board-body{padding:0; background:var(--panel)}

    /* AWC-like vertical blocks */
    .wx{padding:14px 16px; border-bottom:1px solid var(--rule)}
    .wx:last-child{border-bottom:0}
    .wx-icao{font-weight:800; letter-spacing:.5px; margin-bottom:6px}
    .wx-icao code{font-size:15px}
    .wx-pre{
      margin:0 0 10px; padding:0;
      font:15px/1.5 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      white-space:pre-wrap; word-break:break-word; color:var(--fg);
    }
    .wx-pre:last-child{margin-bottom:0}

    .muted{color:var(--muted)}
    .trigger{font-weight:800; color:var(--warn)} /* highlight hits */

    .spinner{display:none; margin-left:8px; width:16px; height:16px; border:2px solid #ddd; border-top-color:var(--ink); border-radius:50%; animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{margin-top:auto; border-top:1px solid var(--rule); background:#fafafa}
    .theme-dark footer{background:#0e1216}
    .footwrap{max-width:1200px; margin:0 auto; padding:14px 12px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; font-size:14px; color:var(--muted)}
    .footwrap a{text-decoration:none}
    .footwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="hdr-line">
      <div>
        <h1 style="margin-bottom:6px">CieloTracker — METAR/TAF Monitor</h1>
        <p>by <strong>Sadiom</strong> — For information purposes only.</p>
      </div>
      <div class="utc" id="utcClock" aria-label="Current UTC time">UTC —</div>
    </div>
    <nav class="top">
      <a href="/home.html">Home</a>
      <a href="/support.html">iOS Support</a>
      <a href="/privacy.html">Privacy</a>
    </nav>
  </header>

  <main>
    <div class="toolbar" role="region" aria-label="Controls">
      <div class="group">
        <label title="Space or comma-separated IDs">
          <strong>IDs</strong>
          <input id="ids" type="text" placeholder="e.g., KDEN KATL KLAX" value="KDEN KATL" />
        </label>
      </div>

      <div class="group">
        <label>Theme
          <select id="theme">
            <option value="light" selected>Light</option>
            <option value="dark">Dark</option>
          </select>
        </label>
      </div>

      <div class="group">
        <label>Ceiling (ft)
          <input id="ceil" type="number" value="700" min="0" step="100" />
        </label>
        <label>Visibility (SM)
          <input id="vis" type="number" value="2" min="0" step="0.25" />
        </label>
      </div>

      <div class="group">
        <label class="switch"><input id="showMetar" type="checkbox" checked /> METAR</label>
        <label class="switch"><input id="showTaf" type="checkbox" checked /> TAF</label>
        <label class="switch" title="Sort alphabetically"><input id="alpha" type="checkbox" /> Alphabetize</label>
      </div>

      <div class="group">
        <label class="switch" title="Show only trigger airports">
          <input id="filter" type="checkbox" />
          Filter: Trigger airports
        </label>
        <div class="spinner" id="spin" aria-label="Loading"></div>
      </div>
    </div>

    <div id="err" class="error" role="alert"></div>

    <section class="board" aria-live="polite">
      <div class="board-header">
        <div id="summary" class="muted">Waiting for data…</div>
        <div id="timestamp" class="muted"></div>
      </div>
      <div id="board-body" class="board-body"></div>
    </section>
  </main>

  <footer>
    <div class="footwrap">
      <div>© 2025 Sadiom</div>
      <div>
        <a href="/home.html">Home</a> &nbsp;|&nbsp;
        <a href="/privacy.html">Privacy</a> &nbsp;|&nbsp;
        <a href="/support.html">iOS Support</a>
      </div>
    </div>
  </footer>

  <script>
    // Backend endpoints
    const RENDER_URL = "https://awc-weather-752k4ah3ra-uc.a.run.app/api/render";
    const DATA_URL   = "https://awc-weather-752k4ah3ra-uc.a.run.app/api/weather";

    // El refs
    const $ = (s, r=document) => r.querySelector(s);
    const idsEl = $('#ids');
    const ceilEl = $('#ceil');
    const visEl = $('#vis');
    const showMetarEl = $('#showMetar');
    const showTafEl = $('#showTaf');
    const alphaEl = $('#alpha');
    const filterEl = $('#filter');
    const themeEl = $('#theme');

    const spin = $('#spin');
    const err = $('#err');
    const board = $('#board-body');
    const summary = $('#summary');
    const ts = $('#timestamp');
    const utcClock = $('#utcClock');

    // UTC clock (top-right) — updates every second
    function fmtUTC(d=new Date()){
      const hh = String(d.getUTCHours()).padStart(2,'0');
      const mm = String(d.getUTCMinutes()).padStart(2,'0');
      const ss = String(d.getUTCSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}Z`;
    }
    function tickClock(){
      utcClock.textContent = `UTC — ${fmtUTC()}`;
    }
    tickClock(); setInterval(tickClock, 1000);

    // Theme handling
    function applyTheme(mode){
      document.body.classList.toggle('theme-dark', mode === 'dark');
      localStorage.setItem('ct_theme', mode);
    }
    themeEl.addEventListener('change', e => applyTheme(e.target.value));
    (function initTheme(){
      const saved = localStorage.getItem('ct_theme') || 'light';
      themeEl.value = saved; applyTheme(saved);
    })();

    // Normalize IDs: allow spaces or commas; collapse to comma-list
    function normalizedIds(raw){
      return raw.replace(/[;\n]/g,' ')
                .replace(/\s+/g,' ')          // collapse whitespace
                .trim()
                .replace(/(?:\s|,)+/g, ',')   // spaces/commas -> comma
                .replace(/^,|,$/g,'');        // trim commas
    }

    // Prefs
    function savePrefs(){
      localStorage.setItem('ct_ids', idsEl.value);
      localStorage.setItem('ct_ceil', ceilEl.value);
      localStorage.setItem('ct_vis', visEl.value);
      localStorage.setItem('ct_m', showMetarEl.checked ? '1':'0');
      localStorage.setItem('ct_t', showTafEl.checked ? '1':'0');
      localStorage.setItem('ct_a', alphaEl.checked ? '1':'0');
      localStorage.setItem('ct_f', filterEl.checked ? '1':'0');
    }
    function loadPrefs(){
      const sp = new URLSearchParams(location.search);
      idsEl.value = sp.get('ids') || localStorage.getItem('ct_ids') || "KDEN KATL";
      ceilEl.value = sp.get('ceil') || localStorage.getItem('ct_ceil') || "700";
      visEl.value = sp.get('vis') || localStorage.getItem('ct_vis') || "2";
      showMetarEl.checked = (sp.get('m') ?? localStorage.getItem('ct_m')) !== '0';
      showTafEl.checked   = (sp.get('t') ?? localStorage.getItem('ct_t')) !== '0';
      alphaEl.checked     = (sp.get('a') ?? localStorage.getItem('ct_a')) === '1';
      filterEl.checked    = (sp.get('f') ?? localStorage.getItem('ct_f')) === '1';
    }
    loadPrefs();

    // Debounce helper
    function debounce(fn, ms=600){
      let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
    }

    // Gentle throttle: avoid hammering AWC — coalesce to ≥10s between runs
    let lastRun = 0, inflight = false;
    async function throttledFetchAndRender(){
      const now = Date.now();
      if (now - lastRun < 10_000) return; // 10s courtesy
      lastRun = now;
      if (inflight) return;
      inflight = true;
      try { await fetchAndRender(); }
      finally { inflight = false; }
    }

    // Auto-save/refresh on change (debounced)
    const onControlsChanged = debounce(()=>{
      savePrefs();
      throttledFetchAndRender();
    }, 600);
    document.addEventListener('input', (e)=>{
      if (e.target.matches('#ids,#ceil,#vis')) onControlsChanged();
    });
    document.addEventListener('change', (e)=>{
      if (e.target.matches('#showMetar,#showTaf,#alpha,#filter,#theme')) onControlsChanged();
    });

    // Auto refresh every 60s
    setInterval(throttledFetchAndRender, 60_000);

    async function fetchAndRender(){
      const ids = normalizedIds(idsEl.value);
      const params = new URLSearchParams({
        ids,
        ceil: ceilEl.value,
        vis: visEl.value,
        metar: showMetarEl.checked ? '1':'0',
        taf: showTafEl.checked ? '1':'0',
        alpha: alphaEl.checked ? '1':'0',
        filter: filterEl.checked ? 'trigger':'all',
      });

      spin.style.display = 'inline-block';
      err.style.display = 'none';
      err.textContent = '';
      summary.textContent = 'Loading…';

      try {
        let html = await tryRender(params);
        if (!html) {
          const data = await fetchJSON(params);
          html = clientSideFallbackRender(data);
        }
        board.innerHTML = html;

        // UTC updated time
        const d = new Date();
        const hh = String(d.getUTCHours()).padStart(2,'0');
        const mm = String(d.getUTCMinutes()).padStart(2,'0');
        ts.textContent = `Updated: ${hh}:${mm}Z`;

        const count = ids ? ids.split(',').filter(Boolean).length : 0;
        summary.innerHTML = `${count} airport(s) &nbsp;•&nbsp; Theme: ${themeEl.value} &nbsp;•&nbsp; Filter: ${filterEl.checked ? 'Trigger' : 'All'}`;
      } catch (e) {
        err.style.display = 'block';
        err.textContent = e && e.message ? e.message : String(e);
      } finally {
        spin.style.display = 'none';
      }
    }

    async function tryRender(params){
      try{
        const res = await fetch(`${RENDER_URL}?${params}`, { method: 'GET' });
        if (res.status === 404) return '';
        if (!res.ok) throw new Error(`Render API ${res.status} ${res.statusText}`);
        return await res.text(); // backend HTML
      } catch (e) {
        if (e.message && /Render API/.test(e.message)) throw e;
        return '';
      }
    }

    async function fetchJSON(params){
      const res = await fetch(`${DATA_URL}?${params}`, { method: 'GET' });
      if (!res.ok) throw new Error(`Data API ${res.status} ${res.statusText}`);
      return await res.json();
    }

    // Fallback vertical renderer with highlighting + robust TAF field detection
    function clientSideFallbackRender(payload){
      const rows = (payload && payload.results) ? payload.results : [];
      if (!rows.length) return `<div class="muted" style="padding:12px">No results.</div>`;

      // Sort
      let list = rows.slice();
      if (alphaEl.checked) list.sort((a,b)=> (a.icao||'').localeCompare(b.icao||''));

      // Trigger logic (fallback only)
      const isTrigger = (r)=>{
        const raw = `${r.metar?.raw||r.metar?.text||''}\n${readTafRaw(r)||''}`;
        const cigHit = /\b(?:BKN|OVC)0{0,2}0?[0-6]\b/.test(raw);
        const visHit = /\b(M1\/2SM|1\/2SM|3\/4SM|1 1\/2SM|1SM)\b/i.test(raw) ||
                       (Number(r.metar?.visibility_sm) > 0 && r.metar.visibility_sm < Number(visEl.value||2));
        const flagHit = r.flags?.metar_ceiling_below || r.flags?.taf_ceiling_below ||
                        r.flags?.metar_visibility_below || r.flags?.taf_visibility_below;
        return cigHit || visHit || flagHit;
      };
      if (filterEl.checked) list = list.filter(isTrigger);

      const showM = showMetarEl.checked, showT = showTafEl.checked;

      const hilite = (text)=>{
        text = text.replace(/\b(BKN|OVC)(0{0,2}0?[0-6])\b/g, '<span class="trigger">$1$2</span>');
        text = text.replace(/\b(M1\/2SM|1\/2SM|3\/4SM|1 1\/2SM|1SM)\b/gi, '<span class="trigger">$1</span>');
        return text;
      };

      let out = '';
      for (const r of list){
        const icao = r.icao || '';
        const metarRaw = r.metar?.raw || r.metar?.text || '';
        const tafRaw   = readTafRaw(r); // handles several shapes

        out += `<article class="wx">
          <div class="wx-icao"><code>${escapeHtml(icao)}</code></div>
          ${showM ? `<pre class="wx-pre">${hilite(escapeHtml(metarRaw))}</pre>` : ''}
          ${showT ? (tafRaw ? `<pre class="wx-pre">${hilite(escapeHtml(tafRaw))}</pre>`
                             : `<div class="muted">No TAF</div>`) : ''}
        </article>`;
      }
      return out || `<div class="muted" style="padding:12px">No results.</div>`;
    }

    // Try a few common TAF shapes
    function readTafRaw(r){
      if (!r || !r.taf) return '';
      return r.taf.raw || r.taf.text || r.taf_raw || r.tafRaw || (typeof r.taf === 'string' ? r.taf : '');
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m]
      ));
    }

    // Initial load
    throttledFetchAndRender();
  </script>

  <!-- AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4340045707749192" crossorigin="anonymous"></script>
</body>
</html>
