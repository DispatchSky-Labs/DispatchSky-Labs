<script>
    // Backend endpoint
    const DATA_URL = "https://us-central1-handy-coil-469714-j2.cloudfunctions.net/process-weather-data-cf";

    const $ = (s, r = document) => r.querySelector(s);
    const idsEl = $('#ids');
    const ceilEl = $('#ceil');
    const visEl = $('#vis');
    const showMetarEl = $('#showMetar');
    const showTafEl = $('#showTaf');
    const alphaEl = $('#alpha');
    const filterEl = $('#filter');
    const themeEl = $('#theme');

    const spin = $('#spin');
    const err = $('#err');
    const board = $('#board-body');
    const summary = $('#summary');
    const ts = $('#timestamp');

    // Theme handling
    function applyTheme(mode) {
        document.body.classList.toggle('theme-dark', mode === 'dark');
        localStorage.setItem('ct_theme', mode);
    }
    themeEl.addEventListener('change', e => { applyTheme(e.target.value); });
    (function initTheme() {
        const saved = localStorage.getItem('ct_theme') || 'light';
        themeEl.value = saved; applyTheme(saved);
    })();

    // UTC clock
    function updateUtcClock() {
        const d = new Date();
        const hh = String(d.getUTCHours()).padStart(2, '0');
        const mm = String(d.getUTCMinutes()).padStart(2, '0');
        $('#utcNow').textContent = `UTC ${hh}:${mm}`;
    }
    updateUtcClock();
    setInterval(updateUtcClock, 30 * 1000);

    // Preferences
    function savePrefs() {
        localStorage.setItem('ct_ids', idsEl.value.trim());
        localStorage.setItem('ct_ceil', ceilEl.value);
        localStorage.setItem('ct_vis', visEl.value);
        localStorage.setItem('ct_m', showMetarEl.checked ? '1' : '0');
        localStorage.setItem('ct_t', showTafEl.checked ? '1' : '0');
        localStorage.setItem('ct_a', alphaEl.checked ? '1' : '0');
        localStorage.setItem('ct_f', filterEl.checked ? '1' : '0');
    }
    function loadPrefs() {
        const sp = new URLSearchParams(location.search);
        idsEl.value = sp.get('ids') || localStorage.getItem('ct_ids') || "KDEN,KATL";
        ceilEl.value = sp.get('ceil') || localStorage.getItem('ct_ceil') || "700";
        visEl.value = sp.get('vis') || localStorage.getItem('ct_vis') || "2";
        showMetarEl.checked = (sp.get('m') ?? localStorage.getItem('ct_m')) !== '0';
        showTafEl.checked = (sp.get('t') ?? localStorage.getItem('ct_t')) !== '0';
        alphaEl.checked = (sp.get('a') ?? localStorage.getItem('ct_a')) === '1';
        filterEl.checked = (sp.get('f') ?? localStorage.getItem('ct_f')) === '1';
    }
    loadPrefs();

    function normalizedIds() {
        return (idsEl.value || '')
            .trim()
            .replace(/[\s;]+/g, ',')
            .replace(/,+/g, ',')
            .replace(/^,|,$/g, '');
    }

    const loadBtn = $('#loadBtn');
    loadBtn.addEventListener('click', () => { savePrefs(); fetchAndRender(); });

    function controlsChanged(e) {
        if (e.target.matches('#theme,#ceil,#vis,#showMetar,#showTaf,#alpha,#filter')) {
            savePrefs();
            fetchAndRender();
        }
    }
    document.addEventListener('change', controlsChanged);
    document.addEventListener('input', controlsChanged);

    let lastFetchAt = 0;
    setInterval(() => {
        if (Date.now() - lastFetchAt >= 60 * 1000) {
            if (lastFetchAt !== 0) fetchAndRender(true);
        }
    }, 5000);

    async function fetchAndRender(quiet) {
        const ids = normalizedIds();
        const params = new URLSearchParams({
            ids,
            ceil: ceilEl.value,
            vis: visEl.value,
            metar: showMetarEl.checked ? '1' : '0',
            taf: showTafEl.checked ? '1' : '0',
            alpha: alphaEl.checked ? '1' : '0',
            filter: filterEl.checked ? 'trigger' : 'all',
        });

        if (!quiet) {
            summary.textContent = 'Loading…';
            spin.style.display = 'inline-block';
            err.style.display = 'none';
            err.textContent = '';
        }

        try {
            const data = await fetchJSON(params);
            const html = clientSideFallbackRender(data);
            board.innerHTML = html;

            const d = new Date();
            const hh = String(d.getUTCHours()).padStart(2, '0');
            const mm = String(d.getUTCMinutes()).padStart(2, '0');
            ts.textContent = `Updated: ${hh}:${mm} UTC`;

            const count = ids ? ids.split(',').filter(Boolean).length : 0;
            summary.textContent = `${count} airport(s) • Theme: ${themeEl.value} • Filter: ${filterEl.checked ? 'Trigger' : 'All'}`;

            lastFetchAt = Date.now();
        } catch (e) {
            err.style.display = 'block';
            err.textContent = e && e.message ? e.message : String(e);
        } finally {
            spin.style.display = 'none';
        }
    }

    async function fetchJSON(params) {
        const res = await fetch(`${DATA_URL}?${params}`, { method: 'GET', mode: 'cors' });
        if (!res.ok) throw new Error(`Data API ${res.status} ${res.statusText}`);
        return await res.json();
    }

    function clientSideFallbackRender(payload) {
        const rows = (payload && payload.results) ? payload.results : [];
        if (!rows.length) return `<div class="muted" style="padding:12px">No results.</div>`;

        let list = rows.slice();
        if (alphaEl.checked) list.sort((a, b) => (a.icao || '').localeCompare(b.icao || ''));

        const showM = showMetarEl.checked;
        const showT = showTafEl.checked;

        let html = '';
        for (const r of list) {
            const metarRaw = r.metar?.raw || '';
            const tafRaw = r.taf?.raw || '';

            html += `<div class="row">
                <div class="col-icao">${escapeHtml(r.icao || '')}</div>
                <div class="col-wx">`;

            if (showM) {
                html += metarRaw
                    ? `<pre class="wx">${escapeHtml(metarRaw)}</pre>`
                    : `<div class="muted" style="padding:10px 12px;">No METAR</div>`;
            }
            if (showT) {
                html += tafRaw
                    ? `<pre class="wx">${escapeHtml(tafRaw)}</pre>`
                    : `<div class="muted" style="padding:10px 12px;">No TAF</div>`;
            }

            html += `</div></div>`;
        }
        return html;
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    // Update DATA_URL to use the new function
    const DATA_URL = "https://us-central1-handy-coil-469714-j2.cloudfunctions.net/process-weather-data-cf";

    // Initial fetch
    fetchAndRender();
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4340045707749192" crossorigin="anonymous"></script>
</body>
</html>
