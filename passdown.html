<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CieloTracker Pro – Passdown</title>
  <style>
    :root {
      --bg:#f9fafb; --fg:#111827; --muted:#6b7280; --border:#e5e7eb;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family: 'Courier New', monospace;
      background:var(--bg); color:var(--fg); font-size:13px; padding:20px; line-height:1.6;
    }
    .theme-dark {
      --bg:#0b0f14; --fg:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
    }
    .theme-dark body { background:var(--bg); color:var(--fg); }
    .container { max-width:900px; margin:0 auto; }
    h1 { margin:0 0 16px 0; font-size:20px; font-weight:600; }
    .flight-block { margin-bottom:24px; padding:16px; background:#fff; border:1px solid var(--border); border-radius:6px; }
    .theme-dark .flight-block { background:#1f2937; border-color:#374151; }
    .flight-header { font-weight:600; font-size:14px; margin-bottom:8px; }
    .wx-line { white-space:pre-wrap; word-break:break-word; font-size:12px; margin:4px 0; }
    .no-data { text-align:center; color:var(--muted); padding:40px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>CieloTracker Pro – Passdown</h1>
    <div id="passdownContent"></div>
  </div>

  <script>
    (function() {
      'use strict';

      function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return String(text).replace(/[&<>"']/g, m => map[m]);
      }

      // Safely get raw string from {raw}, string, or missing
      function rawString(x) {
        if (!x) return '';
        if (typeof x === 'string') return x;
        if (x && typeof x.raw === 'string') return x.raw;
        return '';
      }

      function upper(str) {
        return (str || '').toString().trim().toUpperCase();
      }

      const flightsData = localStorage.getItem('ct_pro_flights_for_passdown');
      const weatherData = localStorage.getItem('ct_pro_weather_for_passdown');

      const content = document.querySelector('#passdownContent');

      if (!flightsData || !weatherData) {
        content.innerHTML = '<div class="no-data">No flight data available</div>';
        applyTheme();
        return;
      }

      let flights = [];
      let weather = {};

      try {
        flights = JSON.parse(flightsData) || [];
        weather = JSON.parse(weatherData) || {};
      } catch (e) {
        content.innerHTML = '<div class="no-data">Error loading data</div>';
        applyTheme();
        return;
      }

      // Include flights that have takeoff alternates, ALT1, or ALT2
      const flightsWithAlternates = flights.filter(f => upper(f.takeoffAlt) || upper(f.alt1) || upper(f.alt2));

      if (flightsWithAlternates.length === 0) {
        content.innerHTML = '<div class="no-data">No flights with alternates</div>';
        applyTheme();
        return;
      }

      const html = flightsWithAlternates.map(f => {
        const flightNum = escapeHtml(f.flight || '');
        const origin = upper(f.origin);
        const dest = upper(f.dest);
        const takeoffAlt = upper(f.takeoffAlt);
        const alt1 = upper(f.alt1);
        const alt2 = upper(f.alt2);

        // Header line: flight, origin, dest, then "Takeoff Alternate" + T/ALT, then "Alternate" + ALT1, then "Secondary Alternate" + ALT2
        const headerParts = [flightNum, origin, dest];
        if (takeoffAlt) {
          headerParts.push(`Takeoff Alternate ${takeoffAlt}`);
        }
        if (alt1) {
          headerParts.push(`Alternate ${alt1}`);
        }
        if (alt2) {
          headerParts.push(`Secondary Alternate ${alt2}`);
        }
        const headerCodes = headerParts.join(' ');

        // Weather blocks: Destination first, then Takeoff Alternate, then ALT1, then ALT2
        const blocks = [];
        const airportsInOrder = [
          dest ? { icao: dest, label: dest } : null,
          takeoffAlt ? { icao: takeoffAlt, label: `Takeoff Alternate ${takeoffAlt}` } : null,
          alt1 ? { icao: alt1, label: `Alternate ${alt1}` } : null,
          alt2 ? { icao: alt2, label: `Secondary Alternate ${alt2}` } : null
        ].filter(Boolean);

        airportsInOrder.forEach(({ icao, label }) => {
          const wx = weather[icao] || {};
          const metar = rawString(wx.metar);
          const taf = rawString(wx.taf);

          if (metar) {
            blocks.push(`<div class="wx-line">${escapeHtml(metar)}</div>`);
          }
          if (taf) {
            blocks.push(`<div class="wx-line">${escapeHtml(taf)}</div>`);
          }
        });

        return `
          <div class="flight-block">
            <div class="flight-header">${headerCodes}</div>
            ${blocks.join('')}
          </div>
        `;
      }).join('');

      content.innerHTML = html;
      applyTheme();

      function applyTheme() {
        const theme = localStorage.getItem('ct_pro_theme') || 'light';
        if (theme === 'dark') {
          document.body.classList.add('theme-dark');
        }
      }
    })();
  </script>

</body>
</html>
